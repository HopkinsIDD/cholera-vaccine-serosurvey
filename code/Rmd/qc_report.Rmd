---
date: "`r Sys.Date()`"
output: 
    html_document: 
        toc: true
        toc_float: true
params:
  batch_id: batch_id 
  merge_obj: merge_obj
  iso: iso
  curves: curves
  controls: controls
title: "Quality Control for `r glue::glue('{params$batch_id} [{params$iso}]')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message=FALSE,warning=FALSE, eval = FALSE,
                      fig.width = 10, fig.height = 8)

pacman::p_load(
        tidyverse,
        downloadthis
)

```

## Overview

- Plate ID: `r params$batch_id` 
- Date of Run: `r unique(params$merge_obj$data_extract$date)`
- Technician Name: `r if(params$merge_obj$layout_extract$summary$version=="1.1") params$merge_obj$layout_extract$summary$description[1,4]%>% as.character()`
- Plate Notes: `r params$merge_obj$layout_extract$summary$description[3,2]%>% as.character()`

Isotype & Subclass:

```{r eval=TRUE}
params$merge_obj$layout_extract$summary$antibody %>%
  filter(isotype==params$iso)%>%
  select(isotype,subclass,wells) %>%
  flextable::flextable() %>%
  flextable::autofit()

```

Antigen:

```{r eval=TRUE}

if(params$merge_obj$layout_extract$summary$version=="1.0"){
        
        params$merge_obj$layout_extract$summary$antigen %>%
                select(antigen_name,coupling_date,lot_number,wells)%>%
                  flextable::flextable() %>%
                  flextable::autofit()
                        
}


if(params$merge_obj$layout_extract$summary$version=="1.1"){
        
        params$merge_obj$layout_extract$summary$antigen %>%
                select(antigen_name,BeadID,coupling_date,lot_number,wells)%>%
                  flextable::flextable() %>%
                  flextable::autofit()
        
}

```


## Bead Counts

- Bead counts under 30 are considered unusable

### Heatmap

```{r count-heat, eval=TRUE}
full_data <- params$merge_obj$extract_merge %>%
                mutate(location_number=str_extract(location,"[0-9]{1,2}"),
                       location_letter=str_extract(location,"[A-Z]{1,2}")
                       ) %>%
                mutate(location_number=as.numeric(location_number))%>%
                filter(isotype==params$iso)%>%
                filter(subclass==unique(params$merge_obj$layout_extract$summary$antibody$subclass))



full_data %>%
  full_join(expand_grid(location_letter=LETTERS[1:16],
                        antigen_exponent=unique(full_data$antigen_exponent)
  ),by = c("antigen_exponent", "location_letter")) %>%
  filter(!is.na(sample))%>% 
  mutate(count_factor=cut(Count,breaks = c(0,1,30,50,100,1000,3000),right = FALSE))%>%     
  ggplot(aes(x=location_number,
             y=location_letter),
  )+
  # geom_tile(aes(fill=Count))+
  # scale_fill_viridis_b(option="plasma",direction=-1,breaks=c(1,30,50,100,1000),
  #                      trans="sqrt",
  #                      limits=c(0,3000)#,
  #                      # guide = guide_legend(label.theme = element_text())
  # 
  # )+
  geom_tile(aes(fill=count_factor))+
  scale_fill_manual("Count",
                    values=c("red","orange","yellow","blue","dark blue","magenta"),
                    drop = FALSE
                    )+     
  facet_wrap(.~batch)+
  theme_bw()+
  facet_wrap(.~antigen_exponent)+
  scale_x_continuous("Number",limits=c(0,24),breaks = c(6,12,18,24))+
  scale_y_discrete("Letter",limits=LETTERS[1:16] %>% rev())



```


### Antigen-wells with low counts

```{r low-count, eval=TRUE}

count_threshold <- 30
tab1 <- filter(params$merge_obj$extract_merge, Count<count_threshold) %>%
                        filter(!str_detect(sample,"Blank"))  %>%
                filter(isotype==params$iso)%>%
                filter(subclass==unique(params$merge_obj$layout_extract$summary$antibody$subclass))


tab1 %>%
  DT::datatable()

tab1 %>% download_this(
  output_name = paste0("low_bead_counts",params$batch_id,params$iso,sep="_"),
  output_extension = ".xlsx",
  button_label = "Download as xlsx",
  button_type = "warning",
  has_icon = TRUE,
  icon = "fa fa-save"
)

```

## Coefficient of variation (CV)

- CV was calculated after MFI measurements were log10 transformed.

### Controls and Standards with CV>20%

```{r cv1, eval=TRUE}

cv_threshold <- 0.2
high_cv <- filter(params$merge_obj$extract_merge, Count>=count_threshold) %>%
                filter(isotype==params$iso)%>%
                filter(subclass==unique(params$merge_obj$layout_extract$summary$antibody$subclass))%>%
                #work on the log scale
                mutate(MFI=log10(MFI))%>%
                #calculate the average MFI and CV
                group_by(batch,sample,isotype,subclass,antigen_exponent) %>%
                mutate( replicates=n(),  
                        avgMFI=mean(MFI),
                        sdMFI=sd(MFI)
                ) %>%
                mutate(cvMFI=sdMFI/avgMFI,
                       diff_avg=MFI-avgMFI
                )  %>%
                filter(cvMFI> cv_threshold) 


cv_df1 <- high_cv%>%
        filter(type %in% c("Control","Standard"))%>%
        filter(isotype==params$iso)


cv_df1 %>%DT::datatable()

cv_df1 %>% download_this(
  output_name = paste0("cv1_summary",params$batch_id,params$iso,sep="_"),
  output_extension = ".xlsx",
  button_label = "Download as xlsx",
  button_type = "warning",
  has_icon = TRUE,
  icon = "fa fa-save"
)

```

### Samples with CV>20%

```{r cv2, eval=TRUE}

cv_df2 <- high_cv %>%
        filter(type =="Sample")%>%
        filter(isotype==params$iso)

cv_df2 %>% DT::datatable()

cv_df2 %>% download_this(
  output_name = paste0("cv2_summary",params$batch_id,params$iso,sep="_"),
  output_extension = ".xlsx",
  button_label = "Download as xlsx",
  button_type = "warning",
  has_icon = TRUE,
  icon = "fa fa-save"
)

```


## Dilution curve

- Dashed lines set at 10^2 and 10^5, upper and lower limits for RAU

```{r dilution-curves, eval=TRUE}

fit_curves_df<- filter(params$curves,isotype==params$iso) %>%
                filter(subclass==unique(params$merge_obj$layout_extract$summary$antibody$subclass))

standards_df <- params$merge_obj$extract_merge %>%
        filter(type=="Standard")%>%
        filter(isotype==params$iso) %>%
        filter(subclass==unique(params$merge_obj$layout_extract$summary$antibody$subclass)) %>%
        rename(antigen=antigen_exponent)%>%
        mutate(dilution=str_remove(sample,"\\,"))%>%
        mutate(dilution=str_extract(dilution,"1:[0-9]{1,7}")) %>%
        mutate(dilution=str_remove(dilution,"1:"))%>%
        mutate(dilution=as.numeric(dilution)) %>%
        filter(Count>0)

if(nrow(standards_df)>0){
        ggplot()+
        geom_line(data=fit_curves_df,
                  aes(group=batch,y=prediction,x=dilution),
                  alpha=0.3)+
        geom_point(data=standards_df,
                  aes(y=log10(MFI),x=dilution),
                  col="red",
                  alpha=0.5
                  )+
        scale_x_continuous(trans = "log10")+
        facet_wrap(.~antigen,scales = "free_y")+
        geom_vline(xintercept = c(10^2,10^5),lty=2)+
        ylab("log10(MFI)")+
        cowplot::theme_cowplot()
} 


```

## Positive Controls

```{r positive-controls, eval=TRUE}


positive_controls<- filter(params$controls,isotype==params$iso) %>%
                filter(subclass==unique(params$merge_obj$layout_extract$summary$antibody$subclass)) %>% 
        filter(str_detect(sample,"Sialidase|Hi O1 Positive B"))

#only graph if the plate is included
if(nrow(filter(positive_controls,batch==params$batch_id))>0){
        
        positive_controls %>%
                ggplot(aes(x=reorder(batch,date),y=avgMFI)) +
                geom_point(aes(shape=sample,col=batch==params$batch_id))+
                facet_wrap(.~antigen_exponent)+
                cowplot::theme_cowplot()+
                theme(axis.text.x = element_blank())+
                scale_y_continuous("log10(MFI)",limits=c(0.5,7))+
                xlab("Batch")+
                ggtitle(glue::glue("{params$iso} {unique(params$merge_obj$layout_extract$summary$antibody$subclass)}"))+
                scale_color_manual("Current Batch", values=c("black","red"))


}


```



## Full Data

```{r eval=TRUE}

fd <- params$merge_obj$extract_merge

fd %>%
  DT::datatable()

fd %>%
  download_this(
    output_name = paste0("full_data",params$batch_id,params$iso,sep="_"),
    output_extension = ".xlsx",
    button_label = "Download as xlsx",
    button_type = "warning",
    has_icon = TRUE,
    icon = "fa fa-save"
  )
```



