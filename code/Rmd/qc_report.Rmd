---
date: "`r Sys.Date()`"
output: 
    html_document: 
        toc: true
        toc_float: true
params:
  batch_id: batch_id 
  merge_obj: merge_obj
  iso: iso
  curves: curves
  standards: standards
  low_beads: low_beads
  high_cv: high_cv
title: "Quality Control for `r glue::glue('{params$batch_id} [{params$iso}]')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message=FALSE,warning=FALSE, eval = FALSE,
                      fig.width = 10, fig.height = 8)

pacman::p_load(
        tidyverse,
        downloadthis
)

```

## Overview

- Plate ID: `r params$batch_id` 
- Date of Run: `r params$merge_obj$layout_extract$summary$description[2,2]`
- Technician Name: `r if(params$merge_obj$layout_extract$summary$version=="1.1") params$merge_obj$layout_extract$summary$description[1,4]`
- Plate Notes: `r params$merge_obj$layout_extract$summary$description[3,2]`

Isotype & Subclass:

```{r eval=TRUE}
params$merge_obj$layout_extract$summary$antibody %>%
  filter(isotype==params$iso)%>%
  select(isotype,subclass,wells) %>%
  flextable::flextable() %>%
  flextable::autofit()

```

Antigen:

```{r eval=TRUE}

if(params$merge_obj$layout_extract$summary$version=="1.0"){
        
        params$merge_obj$layout_extract$summary$antigen %>%
                select(antigen_name,coupling_date,lot_number,wells)%>%
                  flextable::flextable() %>%
                  flextable::autofit()
                        
}


if(params$merge_obj$layout_extract$summary$version=="1.1"){
        
        params$merge_obj$layout_extract$summary$antigen %>%
                select(antigen_name,BeadID,coupling_date,lot_number,wells)%>%
                  flextable::flextable() %>%
                  flextable::autofit()
        
}

```


## Bead Counts

### Heatmap

```{r eval=TRUE}
full_data <- params$merge_obj$extract_merge %>%
                mutate(location_number=str_extract(location,"[0-9]{1,2}"),
                       location_letter=str_extract(location,"[A-Z]{1,2}")
                       ) %>%
                mutate(location_number=as.numeric(location_number))


full_data %>%
  full_join(expand_grid(location_letter=LETTERS[1:16],
                        antigen_exponent=unique(full_data$antigen_exponent)
  )) %>%
  filter(!is.na(sample))%>% 
  ggplot(aes(x=location_number,
             y=location_letter),
  )+
  geom_tile(aes(fill=Count))+
  # facet_wrap(.~batch)+
  scale_fill_viridis_b(option="viridis",direction=-1,breaks=c(1,30,50,100,1000),
                       trans="sqrt",
                       limits=c(0,3000)#,
                       # guide = guide_legend(label.theme = element_text())
                       
  )+
  theme_bw()+
  facet_wrap(.~antigen_exponent)+
  scale_x_continuous("Number",limits=c(0,24),breaks = c(6,12,18,24))+
  scale_y_discrete("Letter",limits=LETTERS[1:16] %>% rev())



```


### Antigen-wells with low counts

```{r eval=TRUE}

tab1 <- params$low_beads %>%
                filter(isotype==params$iso)

tab1 %>%
  DT::datatable()

tab1 %>% download_this(
  output_name = paste0("low_bead_counts",params$batch_id,params$iso,sep="_"),
  output_extension = ".xlsx",
  button_label = "Download as xlsx",
  button_type = "warning",
  has_icon = TRUE,
  icon = "fa fa-save"
)

```

## Coefficient of variation (CV)

### Controls and Standards with CV>20%

In the past, we have retested plates when when over half of the positive control dilutions had >=X antigens with a coefficient of variation (calculated from replicate MFI measurements) greater than 20%.

```{r cv1, eval=TRUE}

cv_df1 <- params$high_cv %>%
        filter(type %in% c("Control","Standard"))%>%
        filter(isotype==params$iso)


cv_df1 %>%DT::datatable()

cv_df1 %>% download_this(
  output_name = paste0("cv1_summary",params$batch_id,params$iso,sep="_"),
  output_extension = ".xlsx",
  button_label = "Download as xlsx",
  button_type = "warning",
  has_icon = TRUE,
  icon = "fa fa-save"
)

```

### Samples with CV>20%

```{r cv2, eval=TRUE}

cv_df2 <- params$high_cv %>%
        filter(type =="Sample")%>%
        filter(isotype==params$iso)

cv_df2 %>% DT::datatable()

cv_df2 %>% download_this(
  output_name = paste0("cv2_summary",params$batch_id,params$iso,sep="_"),
  output_extension = ".xlsx",
  button_label = "Download as xlsx",
  button_type = "warning",
  has_icon = TRUE,
  icon = "fa fa-save"
)

```


## Dilution curve

- Dots indicate the log10(MFI) of dilutions on the curve
- Blue rugplot on left indicates the values of non-control wells
- Colored rugplot on the right indicate the log10(MFI) values of control wells

```{r dilution-curves, eval=TRUE}

fit_curves_df<- filter(params$curves,isotype==params$iso) %>%
        filter(subclass==params$merge_obj$layout_extract$summary$antibody$subclass)

standards_df <- filter(params$standards,isotype==params$iso) %>%
        filter(subclass==params$merge_obj$layout_extract$summary$antibody$subclass) %>%
        rename(antigen=antigen_exponent)

ggplot()+
        geom_line(data=fit_curves_df,
                  aes(group=batch,y=prediction,x=dilution),
                  alpha=0.3)+
        geom_point(data=standards_df,
                  aes(y=avgMFI,x=dilution),
                  col="red")+
        scale_x_continuous(trans = "log10")+
        facet_wrap(.~antigen,scales = "free_y")+
        geom_vline(xintercept = c(10^2,10^5),lty=2)+
        ylab("MFI")+
        cowplot::theme_cowplot()

```


```{r}

# control_MFI %>%
#   filter(isotype==iso,!is.na(dilution)) %>%
#   mutate(std_type=case_when(str_detect(Sample,"O1 Standard") ~ "VC O1",
#                             str_detect(Sample,"COVID") ~ "COVID",
#                             str_detect(Sample,"Typhi") ~ "Typhi 6"
#   )) %>%
#   ggplot()+
#   geom_point(aes(x=log10(dilution),y=log10(Median),pch=std_type),alpha=0.3)+
#   geom_rug(data=control_MFI %>%
#              filter(is.na(dilution)) %>%
#              filter(isotype==iso),
#            sides="right",
#            aes(y=log10(Median),
#                col=Sample
#            ))+
#   geom_rug(data=sample_MFI,
#            sides="left",
#            aes(y=log10(Median),
#            ),alpha=0.3, col="blue")+
#   facet_wrap(.~antigen)+
#   theme_cowplot()+
#   ylab("log10(MFI)")+
#   ggtitle(paste(iso,"Dilution Series"))


```



## Full Data

```{r eval=TRUE}

fd <- params$merge_obj$extract_merge

fd %>%
  DT::datatable()

fd %>%
  download_this(
    output_name = paste0("full_data",params$batch_id,params$iso,sep="_"),
    output_extension = ".xlsx",
    button_label = "Download as xlsx",
    button_type = "warning",
    has_icon = TRUE,
    icon = "fa fa-save"
  )
```



