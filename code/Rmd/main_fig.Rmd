---
title: "Main figures for Cholera serosurveillance in partially vaccinated populations"
author: "Forrest Jones"
date: "`r Sys.Date()`"
output:
  html_document:
    self_contained: yes
  word_document: default 
---

```{r setup, include=FALSE}


library(knitr)

knitr::opts_chunk$set(echo = FALSE,message = FALSE,warning = FALSE,
                      cache = TRUE,
                      fig.height = 7,
                      fig.width = 10, eval=FALSE#,
                      #dev="pdf" 
                      )

```





```{r load, eval = TRUE}
rm(list=ls())

source("code/R/packages.R")
source("code/R/utils.R")

# new_qc.R, clean-data.R load-data.R to see how final_df and final_wide are created

final_df <- read_rds("data/generated_data/analysis_data/final_df.rds")
final_wide <-read_rds("data/generated_data/analysis_data/final_wide.rds")


```


## Main Text 

### Abstract

```{r abstract}

final_wide %>%
        filter(studycode!="E01JH") %>%
        nrow()

```

### Results

```{r study-pop1}
final_wide %>%
        filter(cohort %in% c("BGD Vaccinee","HTI Vaccinee")) %>%
        group_by(cohort)%>%
        summarize(samples=n(),
                  individuals=length(unique(id)),
                  under10=length(unique(id[age<10])),
                  male=length(unique(id[sex=="male"]))
                  ) %>%
        mutate(under10=glue::glue("{under10} ({round(under10/individuals,2)*100})"),
               male=glue::glue("{male} ({round(male/individuals,2)*100})")
               )
        


final_wide %>%
        filter(cohort %in% c("SMIC/PIC")) %>%
        filter(status=="Case")%>%
        group_by(cohort)%>%
        summarize(samples=n(),
                  individuals=length(unique(id)),
                  under10=length(unique(id[age<10])),
                  male=length(unique(id[sex=="male"])),
                  culture=length(unique(id[culture=="O1-Ogawa"]))
                  ) %>%
        mutate(under10=glue::glue("{under10} ({round(under10/individuals,2)*100})"),
               male=glue::glue("{male} ({round(male/individuals,2)*100})"),
               culture=glue::glue("{culture} ({round(culture/individuals,2)*100})")
               )

final_wide %>%
        filter(status=="Contact") %>%
        group_by(cohort)%>%
        summarize(samples=n(),
                  individuals=length(unique(id)))


final_wide %>%
        filter(status=="Contact") %>%
        distinct(id,age, sex)

```


```{r study-pop2}

final_wide %>%
        filter(cohort=="BGD Vaccinee") %>%
        count(day)

final_wide %>%
        filter(cohort=="HTI Vaccinee") %>%
        mutate(individuals=length(unique(id))) %>%
        count(day,individuals) %>%
        mutate(percent=round(n/individuals,2)*100)


final_wide %>%
        filter(cohort %in% c("SMIC/PIC")) %>%
        filter(status=="Case")%>%
        count(id) %>% 
        summary()

final_wide %>%
        filter(cohort %in% c("SMIC/PIC")) %>%
        filter(status=="Contact")%>%
        count(day) %>% 
        summary()
```

__Table 1:Individual characteristics of culture confirmed cholera patients and vaccinated individuals__

Serological data were also available for three uninfected household contacts of Bangladeshi cases enrolled with measurements taken at 2, 7, and 30 days after enrollment of the initial case


```{r table-1, eval=TRUE}


tab1_df <- final_df %>%
        filter(status %in% c("Case","Vaccinee")) %>%
        distinct(cohort,studycode,id,age_group,sex,blood,culture,status) %>%
# get categorical variables together
        group_by(cohort) %>%
        summarize(n=n(),
                  `< 5 years`=sum(age_group=="<5 years"),
                  `5-9 years`=sum(age_group=="5-9 years"),
                  `10-17 years`=sum(age_group=="10-17 years"),
                  `18+ years`=sum(age_group=="18+ years"),
                  
                  Female = sum(sex=="female"),
                  
                  `O Blood Group` = sum(blood=="O"),
                  
                  `V. cholerae O1 Ogawa isolated` = sum(culture=="O1-Ogawa"),
        ) %>%
        gather(variable,value,-c(cohort,n)) %>% 
        # filter(!is.na(value)) %>%
        mutate(percent=round(value/n*100)) %>%
        mutate(final_value= ifelse(is.na(value),"-",paste0(value," (",percent,")"))) %>%
        mutate(row_name=paste(variable,"(%)")) %>%
        select(cohort,n,row_name,final_value)


tab1_df %>%
        mutate(row_name=factor(row_name,
                               levels = c("< 5 years (%)",                     "5-9 years (%)"  ,                  
                                          "10-17 years (%)"   ,                "18+ years (%)"     ,               
                                          "Female (%)"  ,                      "O Blood Group (%)" ,               
                                          "V. cholerae O1 Ogawa isolated (%)")
        )) %>%
        mutate(column_header= case_when(
                cohort == "SMIC/PIC" ~ "Bangladeshi cholera cases",
                cohort == "BGD Vaccinee" ~ "Bangladeshi vaccinees",
                cohort == "HTI Vaccinee" ~ "Haitian vaccinees"
                
        )) %>%
        mutate(column_header=paste0(column_header,"\n(n=",n,")")) %>%
        select(column_header,row_name,final_value) %>%
        spread(column_header,final_value) %>%
        bind_rows(data.frame(row_name="Age Group"),.) %>%
        rename(Characteristics=row_name) %>%
        flextable::flextable() %>%
        flextable::autofit() %>%
        flextable::padding(i=2:5, j=1, padding.left=20) %>%
        flextable::align(align = "center",j=2:4,part="all") %>%
        flextable::width(width = 1.5) 


```


\pagebreak

#### Immune response to vaccination and infection differ in magnitude and breadth

__Figure 1:  Multiplex bead assay measurements of IgG, IgM, and IgA against OSP, CT-B, and TcpA antigens among vaccinated volunteers__



```{r f1-spaghetti-rau,  eval=TRUE, fig.height = 7, fig.width = 10}

#data for figure 1
fig1_df <- final_df %>% 
        filter(antigen_pretty %in% c("Ogawa OSP","Inaba OSP","O139 OSP","CT-B","TcpA")) %>%
        mutate(antigen_pretty=factor(antigen_pretty,levels=c("Ogawa OSP","Inaba OSP","O139 OSP","CT-B","TcpA"))) %>%
        mutate(isotype=factor(isotype,levels=c("IgG","IgA","IgM"))) %>%
        filter(studycode!="R1") 



#case true positives
true_pos <- fig1_df %>% filter(
                   status=="Case",
                   day > 2,
                   day<200
                   )

#case true negatives
true_neg <- fig1_df %>%
                filter(cohort=="SMIC/PIC") %>%
                anti_join(true_pos)
        



f1 <- fig1_df %>%
        filter(status=="Vaccinee")  %>%
        mutate(Vaccinee=case_when(
                cohort== "BGD Vaccinee" & age <10 ~ "Bangladeshi < 10 years",
                cohort== "BGD Vaccinee" & age>=10 ~ "Bangladeshi 10+ years",
                TRUE ~ "Haitian 18+ years"
        )) %>%
        ggplot(aes(y=RAU_value))+
                geom_line(aes(group=id,
                              x=day,
                              col=Vaccinee
                              ),
                          alpha=0.5
                          )+
        # geom_point(aes(
        #                       x=day,
        #                       col=Vaccinee
        #                       ),
        #                   alpha=0.5
        #                   )+
                geom_rug(data=true_pos,sides="l",col="red",alpha=0.3)+
                geom_rug(data=true_neg,sides="r",col="black",alpha=0.3)+
                facet_grid(isotype~antigen_pretty)+
                scale_color_manual(values = c("lightblue","#003262","#FDB515")
                                   )+
                scale_x_continuous("Days since first dose",breaks=c(1,30,200,365) ,trans="sqrt")+
        geom_vline(xintercept = 14,lty=2)+
        ylab("log10(1/RAU)")+
        guides(color=guide_legend(override.aes=list(alpha=NA)))+
        theme_cowplot()+
        theme(legend.position = "bottom")
  
  
f1

ggsave(plot=f1,filename="figures/main_text/figure1.pdf", height = 4.36,width = 6.5,scale = 1.5)
ggsave(plot=f1,filename="figures/main_text/figure1.png", height = 4.36,width = 6.5,scale = 1.5)
```


\pagebreak


#### Previous seroincidence models frequently misclassify vaccination as recent infection

__Figure 2:  Misclassification of vaccinees as seropositive by previous seroincidence models using 45, 120, 200, and 300 day infection windows__

```{r misclassification-code, eval=FALSE}

# Misclassification.R provides predictions for misclassification of vaccinees
source("code/R/misclassification.R")

```

```{r misclassify-figure, eval=TRUE,fig.width=9.1,fig.height=7}



#get data for misclassification
misclassify_df <- read_rds("data/generated_data/analysis_objects/misclassification/misclassify_df.rds")
tvfpr_df <- read_rds("data/generated_data/analysis_objects/misclassification/tvfpr_df.rds")


misclassify_df%>% filter(variables=="Reduced IgG Panel")%>%
        filter(cohort %in% c("HTI Vaccinee","BGD Vaccinee"))%>%
        filter(end_window %in% c("45"))%>%
        group_by(day,end_window,cohort) %>%
        summarize(seropos=sum(spec95_seropos),
                  n=n(),
                  )%>%
        mutate(per_pos=seropos/n) %>% 
        arrange(cohort)


filter(tvfpr_df,population== "All Vaccinees (Reduced IgG Panel)") %>%
        filter(end_window %in% c(120,200,300)) %>%
        group_by(end_window) %>%
        filter(median==max(median))



filter(tvfpr_df,population== "All Vaccinees (Reduced IgG Panel)") %>%
        filter(end_window %in% c(120,200,300)) %>%
        group_by(end_window) %>%
        filter(median>=0.05) %>%
        filter(time==min(time))

filter(tvfpr_df,population== "All Vaccinees (Reduced IgG Panel)") %>%
        filter(end_window %in% c(120,200,300)) %>%
        group_by(end_window) %>%
        filter(median>=0.05) %>%
        filter(time==max(time))


# filter(tvfpr_df,population== "All Vaccinees (Reduced IgG Panel [NO AGE])") %>%
#         filter(end_window %in% c(120,200,300)) %>%
#         filter(time>14)%>%
#         group_by(end_window) %>%
#         slice_min(abs(median-0.05),n=1)


misclassify_df%>% filter(variables=="Reduced IgG Panel")%>%
        filter(cohort %in% c("ETEC Challenge"))%>%
        filter(end_window %in% c("200"))%>%
        group_by(day,end_window,cohort) %>%
        summarize(seropos=sum(spec95_seropos),
                  n=n(),
                  )%>%
        mutate(per_pos=seropos/n) 



f2a <- misclassify_df %>% filter(variables=="Reduced IgG Panel")%>%
        filter(cohort %in% c("HTI Vaccinee","BGD Vaccinee"))%>%
        group_by(day,end_window,cohort) %>%
        summarize(seropos=mean(spec95_seropos))%>%
        filter(end_window %in% c("45","120","200","300"))%>%
        mutate(end_window=factor(end_window,
                        levels=c("45","120","200","300"),
                        labels=c("45-day","120-day","200-day","300-day")))%>%
        mutate(Vaccinee=case_when(
                        cohort=="BGD Vaccinee" ~ "Bangladeshi",
                        cohort=="HTI Vaccinee" ~ "Haitian"
        )) %>%
        ggplot()+
        geom_point(aes(col=Vaccinee,
                   y=seropos,x=day,shape=Vaccinee))+
        geom_line(data=filter(tvfpr_df,population== "All Vaccinees (Reduced IgG Panel)")%>%
                        mutate(end_window=factor(end_window,
                                 levels=c("45","120","200","300"),
                                 labels=c("45-day","120-day","200-day","300-day"))),
                        aes(x=time,y=median))+
        geom_ribbon(data=filter(tvfpr_df,population== "All Vaccinees (Reduced IgG Panel)")%>%
                        mutate(end_window=factor(end_window,
                                 levels=c("45","120","200","300"),
                                 labels=c("45-day","120-day","200-day","300-day"))),
                        aes(x=time,ymin=lb,ymax=ub),col=NA,
                                    alpha=0.2,
                        )+
        facet_grid(.~end_window)+
        theme_cowplot()+
        scale_x_continuous("Days since first dose",breaks=seq(0,365,90))+
        scale_y_continuous("Proportion Seroincident")+
        scale_color_manual(values = c("#003262","#FDB515"))+
        scale_shape_manual(values=c(1,1))+
        geom_hline(yintercept = 0.05,lty=2)+
        theme(legend.position = "bottom")
        
      

nmfp_label_df <- data.frame(
                end_window="45",
                X=270,
                Y=0.15
) %>% mutate(end_window=factor(end_window,
                                 levels=c("45","120","200","300"),
                                 labels=c("45-day","120-day","200-day","300-day")))
  
f2<- f2a + geom_text(data=nmfp_label_df,
                label="Nominal false\npositive rate",
                aes(x=X,y=Y),fontface="bold"
                )+
  geom_segment(data=nmfp_label_df,
               aes(xend = X, x = X,
               yend =Y-0.095,y=Y-0.03),
    arrow = arrow(length = unit(0.2,"cm"),
                  type="closed"
                  ))

f2

ggsave(plot=f2,filename="figures/main_text/figure2.pdf", height = 2.39,width = 6.5,scale = 1.5)
ggsave(plot=f2,filename="figures/main_text/figure2.png", height = 2.39,width = 6.5,scale = 1.5)


```


__Figure 3: Random forest classification model performance at distinguishing samples of recently infected cases (<200 days) from samples of recently vaccinees, uninfected contacts, and cases that were not recently infected (200+ days).__
```{r loocv-code, eval=FALSE}
source("code/R/loocv_new.R")
```

```{r newfigure3, eval=FALSE}

#load the original model objects
tvfpr_df <- read_rds("data/generated_data/analysis_objects/misclassification/tvfpr_df.rds")
tvfpr_fit <- read_rds(
          paste0("data/generated_data/analysis_objects/misclassification/","tvfpr_fit.rds")
)

tvfpr_fit_200 <- tvfpr_fit$`200`$`All Vaccinees (Reduced IgG Panel)`

#load the new model objects

loocv_tvfit_df <- read_rds(
          paste0("data/generated_data/analysis_objects/loocv/","loocv_tvfit_df_new.rds")
)

loocv_tvfit_list <- read_rds(
          paste0("data/generated_data/analysis_objects/loocv/","loocv_tvfit_list_new.rds")
)

loocv_spec_df<- read_rds(
          paste0("data/generated_data/analysis_objects/loocv/","loocv_spec_df_new.rds")
)

loocv_df <- read_rds("data/generated_data/analysis_objects/loocv/loocv_df_new.rds")


p1 <- loocv_tvfit_df %>%
        filter(time<=200)%>%
        filter(population=="Vaccinee")%>%
        filter(str_detect(variables,"reduced"))%>%
        ggplot(aes(col=variables,fill=variables))+
                geom_line(aes(x=time,y=median))+
                geom_ribbon(aes(x=time,ymin=lb,ymax=ub),alpha=0.5,col=NA)+
                geom_line(data=tvfpr_df %>%
                                  filter(end_window==200)%>%
                                  filter(time<=200)%>%
                                  filter(population=="All Vaccinees (Reduced IgG Panel)"),
                          col="black",aes(x=time,y=median),lwd=1,
                          inherit.aes = FALSE
                          )+
        scale_color_manual(values = c("red","blue"))+
        scale_fill_manual(values = c("red","blue"))+
        xlab("Days since vaccination")+
        scale_y_continuous("False Positive Rate",limits = c(0,0.25))+
        geom_hline(yintercept = 0.05,lty=2)+
        theme_cowplot()+
        theme(legend.position = "none")


p2_vax_df <- bind_rows(
        
        tvfpr_fit_200$out_df %>%
        filter(time<=200) %>% group_by(.draw)%>%
        summarize(avg=mean(theta)) %>%
        ungroup()%>%
        summarize(median=median(avg),
                  lb=quantile(avg,0.025),
                  ub=quantile(avg,0.975)
                  )%>%
        mutate(variables="original"),


        loocv_tvfit_list$reduced_2class$all_fitdata$`200-day`$Vaccinee$out_df %>%
        filter(time<=200) %>% group_by(.draw)%>%
        summarize(avg=mean(theta)) %>%
        ungroup()%>%
        summarize(median=median(avg),
                  lb=quantile(avg,0.025),
                  ub=quantile(avg,0.975)
                  )%>%
        mutate(variables="reduced_2class"),


        loocv_tvfit_list$reduced_3class$all_fitdata$`200-day`$Vaccinee$out_df %>%
        filter(time<=200)%>% group_by(.draw)%>%
        summarize(avg=mean(theta)) %>%
        ungroup()%>%
        summarize(median=median(avg),
                  lb=quantile(avg,0.025),
                  ub=quantile(avg,0.975)
                  ) %>%
                mutate(variables="reduced_3class")
) %>% mutate(population="Vaccinated")  

p2_outside_df <- loocv_spec_df %>% 
                        filter(str_detect(variables,"reduced")) %>%
                        filter(population=="Outside Window") %>%
                        mutate(variables=ifelse(base_data_name=="case_fitdata",
                                                "original",variables
                                                )) %>%
                        mutate(median=1-median,
                               lb_new=1-ub,
                               ub=1-lb
                               )%>%
                        select(median,lb=lb_new,ub,variables,population)%>%
                        mutate(population="Unvaccinated")

p2<- bind_rows(p2_outside_df,p2_vax_df)%>%
        mutate(Model=factor(variables,
                            levels=c("original","reduced_2class","reduced_3class"),
                            labels=c("Infection-Only model",
                                     "Mixed-Cohort\nTwo Class model",
                                     "Mixed-Cohort\nThree Class model"
                                     )
                            )) %>%
        mutate(population=factor(population))%>%
        mutate(population=fct_rev(population))%>%
        ggplot()+
                geom_point(aes(x=population,y=median,col=Model),
                           position = position_dodge(0.5)
                           )+
                geom_linerange(aes(x=population,ymin=lb,ymax=ub,col=Model),
                           position = position_dodge(0.5)
                           )+
        theme_cowplot()+
        geom_hline(yintercept = 0.05,lty=2)+
        scale_color_manual(values = c("black","red","blue"))+
        scale_y_continuous("False Positive Rate",limits = c(0,0.25))+
        xlab("Population")

p3_df <- loocv_tvfit_df %>%
        filter(population=="Case")%>%
        filter(str_detect(variables,"reduced"))%>%
                        mutate(variables=ifelse(base_data_name=="case_fitdata",
                                                "original",variables
                                                )) %>%
        filter(time<=200)




p3 <- p3_df%>%
        filter(str_detect(variables,"reduced"))%>%
        ggplot(aes(col=variables,fill=variables))+
                geom_line(aes(x=time,y=median))+
                geom_ribbon(aes(x=time,ymin=lb,ymax=ub),alpha=0.5,col=NA)+
        geom_line(data=p3_df %>%
                          filter(variables=="original"),
                  col="black",aes(x=time,y=median), lwd=1,
                  inherit.aes = FALSE
                  )+
        scale_color_manual(values = c("red","blue"))+
        scale_fill_manual(values = c("red","blue"))+
        xlab("Days since infection")+
        scale_y_continuous("Sensitivity",limits=c(0,1))+
        theme_cowplot()+
        theme(legend.position = "none")

p4 <- loocv_df %>%
        filter(variables=="reduced_3class") %>%
        mutate(across(Neither:RecentlyVaccinated,.fns = ~ifelse(is.na(.x),
                                                                0,.x
                                                                ))) %>%
        mutate(prediction=case_when(
                Neither >= RecentlyInfected & Neither >=RecentlyVaccinated ~"Neither",
                RecentlyInfected > Neither & RecentlyInfected >= RecentlyVaccinated ~"RecentlyInfected",
                RecentlyVaccinated > Neither & RecentlyVaccinated > RecentlyInfected ~"RecentlyVaccinated"
        )) %>%
        mutate(three_class=factor(three_class),
                  prediction=factor(prediction)
        ) %>%
        count(variables,three_class,prediction,.drop=FALSE) %>%
        group_by(variables,three_class) %>%
        mutate(proportion=n/sum(n)) %>%
        mutate(three_class=str_replace(three_class,"Recently","Recently\n"))%>%
        mutate(three_class=glue::glue("{three_class}\n(n={sum(n)})"))%>%
        mutate(prediction=str_replace(prediction,"Recently","Recently\n"))%>%
        ggplot(aes(x=three_class,y=prediction))+
        geom_tile(aes(fill=100*proportion))+
        geom_text(aes(label=paste0(100*round(proportion,2),"%")))+
        scale_fill_distiller("Percent\nClassified",palette = "Blues",
                             direction = 1,limits=c(0,100),
        )+
        xlab("True Class")+
        ylab("Predicted Class")+
        theme_cowplot()


f3 <- plot_grid(
        plot_grid(p1,p2,nrow=1,rel_widths = c(1,1.2), labels=c("A","B")),
        plot_grid(p3,p4,nrow = 1,rel_widths = c(1,1.2), labels=c("C","D")),
        nrow=2
        )

f3

ggsave(plot=f3,filename="figures/main_text/figure3.pdf", height = 4.22,width = 6.5,scale = 1.5)
ggsave(plot=f3,filename="figures/main_text/figure3.png", height = 4.22,width = 6.5,scale = 1.5)




```


__Figure 4. Simulated serological surveys in settings with varying levels of vaccination coverage using multiple strategies to calculate seroincidence__

The number of days since the first dose of the campaign is shown in parentheses. Blue line violin plots show the distribution of 100 estimates of seroincidence using different strategies (x-axis) at various levels of vaccine coverage (top of each panel). Blue dot indicates the average seroincidence estimate. Each simulated survey had 1000 persons. The true incidence was 10 infections per 100 in 200 days as shown in the grey violin plots. 


```{r simulation-results}

#get sensitivty estimates

#load loocv objects
loocv_spec_list <- read_rds(
        paste0("data/generated_data/analysis_objects/loocv/","loocv_spec_list.rds")
)
loocv_sens_list <- read_rds("data/generated_data/analysis_objects/loocv/loocv_tvfit_list.rds")

loocv_df <- read_rds("data/generated_data/analysis_objects/loocv/loocv_df.rds")


#load stan fit
original_sens_fitdata <-loocv_sens_list$`Reduced IgG Panel`$smicpic_fitdata$`200-day`$Case$data
original_sens_spread <- loocv_sens_list$`Reduced IgG Panel`$smicpic_fitdata$`200-day`$Case$fit %>% 
        spread_draws(`(Intercept)`,
                     b[term,group],
                     day1,day2,day3
        )

#for loop through potential days since infection
original_sens_obj <- data.frame()
original_sens_beta_draws <-data.frame()


for(t in 1:200){
        
        cat(t,"\n")
        time <- log(t) -mean(log(original_sens_fitdata$new_day))
        
        #get individual sensitivities for simulation
        tmp_df <- original_sens_spread %>%
                mutate(logit_theta_j=`(Intercept)` + b+
                               day1*time +
                               day2*time^2+
                               day3*time^3
                       
                ) %>%
                mutate(theta_j = 1/(1+exp(-logit_theta_j)))%>%
                group_by(group) %>%
                summarize(theta=mean(theta_j),n()) %>% #average across individuals here
                mutate(days_ago=t)%>%
                rename(pos_ID=group,
                       ind_sens=theta
                )
        
        original_sens_obj <- bind_rows(original_sens_obj,tmp_df)
        
        #get sensitivity distribution for seroincidence estimation
        tmp_dist <- original_sens_spread %>%
                mutate(logit_theta_j=`(Intercept)` + b+
                               day1*time +
                               day2*time^2+
                               day3*time^3
                       
                ) %>%
                mutate(theta_j = 1/(1+exp(-logit_theta_j)))%>%
                group_by(.draw) %>%
                summarize(theta=mean(theta_j),n()) %>%
                mutate(days_ago=t)
        
        original_sens_beta_draws <-bind_rows(
                original_sens_beta_draws,
                tmp_dist
        )
}


#fit beta distribution
original_sens_beta_draws %>% group_by(.draw)%>%
        summarize(sens=mean(theta)) %>%
        median_qi()



#Alternative model 1
#load stan fit
alt1_sens_fitdata <-loocv_sens_list$`Reduced IgG Panel`$all_fitdata$`200-day`$Case$data
alt1_sens_spread <- loocv_sens_list$`Reduced IgG Panel`$all_fitdata$`200-day`$Case$fit %>% 
        spread_draws(`(Intercept)`,
                     b[term,group],
                     day1,day2,day3
        )

#for loop through potential days since infection
alt1_sens_obj <- data.frame()
alt1_sens_beta_draws <-data.frame()


for(t in 1:200){
        
        cat(t,"\n")
        time <- log(t) -mean(log(alt1_sens_fitdata$new_day))
        
        #get individual sensitivities for simulation
        tmp_df <- alt1_sens_spread %>%
                mutate(logit_theta_j=`(Intercept)` + b+
                               day1*time +
                               day2*time^2+
                               day3*time^3
                       
                ) %>%
                mutate(theta_j = 1/(1+exp(-logit_theta_j)))%>%
                group_by(group) %>%
                summarize(theta=mean(theta_j),n()) %>% #average across individuals here
                mutate(days_ago=t)%>%
                rename(pos_ID=group,
                       ind_sens=theta
                )
        
        alt1_sens_obj <- bind_rows(alt1_sens_obj,tmp_df)
        
        #get sensitivity distribution for seroincidence estimation
        tmp_dist <- alt1_sens_spread %>%
                mutate(logit_theta_j=`(Intercept)` + b+
                               day1*time +
                               day2*time^2+
                               day3*time^3
                       
                ) %>%
                mutate(theta_j = 1/(1+exp(-logit_theta_j)))%>%
                group_by(.draw) %>%
                summarize(theta=mean(theta_j),n()) %>%
                mutate(days_ago=t)
        
        alt1_sens_beta_draws <-bind_rows(
                alt1_sens_beta_draws,
                tmp_dist
        )
}


#fit beta distribution
alt1_sens_beta_draws %>% group_by(.draw)%>%
        summarize(sens=mean(theta)) %>%
        median_qi()



#Alternative model 2
#load stan fit
alt2_sens_fitdata <-loocv_sens_list$`All Variables`$all_fitdata$`200-day`$Case$data
alt2_sens_spread <- loocv_sens_list$`All Variables`$all_fitdata$`200-day`$Case$fit %>% 
        spread_draws(`(Intercept)`,
                     b[term,group],
                     day1,day2,day3
        )

#for loop through potential days since infection
alt2_sens_obj <- data.frame()
alt2_sens_beta_draws <-data.frame()


for(t in 1:200){
        
        cat(t,"\n")
        time <- log(t) -mean(log(alt2_sens_fitdata$new_day))
        
        #get individual sensitivities for simulation
        tmp_df <- alt2_sens_spread %>%
                mutate(logit_theta_j=`(Intercept)` + b+
                               day1*time +
                               day2*time^2+
                               day3*time^3
                       
                ) %>%
                mutate(theta_j = 1/(1+exp(-logit_theta_j)))%>%
                group_by(group) %>%
                summarize(theta=mean(theta_j),n()) %>% #average across individuals here
                mutate(days_ago=t)%>%
                rename(pos_ID=group,
                       ind_sens=theta
                )
        
        alt2_sens_obj <- bind_rows(alt2_sens_obj,tmp_df)
        
        #get sensitivity distribution for seroincidence estimation
        tmp_dist <- alt2_sens_spread %>%
                mutate(logit_theta_j=`(Intercept)` + b+
                               day1*time +
                               day2*time^2+
                               day3*time^3
                       
                ) %>%
                mutate(theta_j = 1/(1+exp(-logit_theta_j)))%>%
                group_by(.draw) %>%
                summarize(theta=mean(theta_j),n()) %>%
                mutate(days_ago=t)
        
        alt2_sens_beta_draws <-bind_rows(
                alt2_sens_beta_draws,
                tmp_dist
        )
}


#fit beta distribution
alt2_sens_beta_draws %>% group_by(.draw)%>%
        summarize(sens=mean(theta)) %>%
        median_qi()


```


```{r simulation-code, eval=FALSE}

source("code/R/simulation.R")

```


```{r simulation-figure, eval=TRUE}
simulation_df <- read_rds("data/generated_data/analysis_objects/simulation/simulation_df_10.rds")
lambda_df <- read_rds("data/generated_data/analysis_objects/simulation/lambda_df_10.rds")
sims_original <- read_rds("data/generated_data/analysis_objects/simulation/sims_original_10.rds")


f4_df <- lambda_df %>%
        mutate(campaign_day=ifelse(campaign_day==21,
                                   "Early serosurvey (21 days post campaign start)",
                                   "Late serosurvey (120 days post campaign start)"
                                   ))%>%
        # group_by(new_strategy,coverage)%>%
        # mutate(avg_lambda=mean(lambda)) %>%
        # ungroup()%>%
        # select(simulation,new_strategy,new_coverage,lambda,avg_lambda) %>%
        # left_join(sims_viz,by = c("simulation", "new_strategy", "new_coverage")) %>%
        # gather(type,value,-c(simulation,new_strategy, new_coverage, coverage))%>%
        ggplot()+
        geom_hline(yintercept=10,lty=2)+
        geom_boxplot(aes(y=lambda*100,x=new_coverage,col=new_adjustment),fill=NA)+
        # geom_violin(aes(y=value,col=type,alpha=type),position="identity",fill="grey",
        #             trim=FALSE,scale="area")+
        scale_color_brewer("Adjustment Method",palette = "Dark2")+
        # scale_alpha_manual(values=c(0,0.3))+
        # geom_point(aes(y=avg_lambda),col="blue")+
        facet_wrap((campaign_day)~.)+
        cowplot::theme_cowplot()+
        # theme(axis.text.x = element_text(angle=45,hjust = 1),
        #       legend.position = "none"
        #       )+
        ylab("200-day seroincidence\n(Infections per 100 population)")+
        xlab("Vaccination Coverage")+
        theme(legend.position = "bottom")

f4

ggsave(plot=f4,filename="figures/main_text/figure4.pdf", height = 2.89,width = 6.09,scale = 1.7)
ggsave(plot=f4,filename="figures/main_text/figure4.png", height = 2.89,width = 6.09,scale = 1.7)


```

```{r, simulation-bias}

f4_df %>% nrow()

table(f4_df$adjustment)

f4_df$campaign_day

#model=adjustment
#campaign_day (will need to change this)
coverage


lambda_df %>%
        mutate(model=ifelse(adjustment=="Alternative",
                            "Alternative","Original"
                            )) %>%
        left_join(simulation_df, by = c("coverage", "campaign_day", "simulation", "model")) %>%
        mutate(bias=(lambda-truth)/truth*100) %>%
        group_by(adjustment,coverage,campaign_day) %>%
        summarise(avg=round(mean(bias)),min=round(min(bias)),max=round(max(bias))) %>% View()
        



# #get the truth form the simulations in the right format
# sims_viz <- filter(simulation_df,campaign_day==21) %>%
#         filter(incidence==0.10)%>%
#                 select(simulation,truth,coverage) %>%
#                 mutate(`Ignore 21`=truth,
#                        `Ignore 120`=truth,
#                        `Questionnaire 21`=truth,
#                        `Alternative NA`=truth,
#                        ) %>%
#                 select(-truth) %>%
#                 gather(new_strategy, truth,-c(simulation,coverage)) %>%
#         mutate(new_strategy = factor(new_strategy,
#                                      levels=c("Ignore 21", "Ignore 120",
#                                               "Questionnaire 21", "Alternative NA"
#                                      ),
#                                      labels=c("Original Model\n(21 days)", "Original Model\n(120 days)",
#                                               "Original Model +\nQuestionnaire\n(21 days)", "Alternative Model 1\n(21 days)")
#         )
#         ) %>%
#         # expand_grid(coverage=c("0% Coverage",
#         #                 "25% Coverage",
#         #                 "50% Coverage",
#         #                 "75% Coverage"
#         # ))%>%
#         mutate(new_coverage=factor(coverage,
#                                    labels=c("0% Coverage",
#                                             "25% Coverage",
#                                             "50% Coverage",
#                                             "75% Coverage"
#                                    )
#         )) 
#                 
# lambda_df  %>%
#         filter(campaign_day == 21 |
#                (adjustment == "Ignore" & campaign_day == 120)|
#                adjustment == "Alternative"
#                        )%>%
#         mutate(new_strategy=paste(adjustment,campaign_day)) %>%
#         mutate(new_strategy = factor(new_strategy,
#                 levels=c("Ignore 21", "Ignore 120",
#                          "Questionnaire 21", "Alternative NA"
#                          ),
#                 labels=c("Original Model\n(21 days)", "Original Model\n(120 days)",
#                          "Original Model +\nQuestionnaire\n(21 days)", "Alternative Model 1\n(21 days)")
#                 )
#                        ) %>%
#         mutate(new_coverage=factor(coverage,
#                                    labels=c("0% Coverage",
#                                             "25% Coverage",
#                                             "50% Coverage",
#                                             "75% Coverage"
#                                             )
#                                    )) %>%
#         group_by(new_strategy,coverage)%>%
#         mutate(avg_lambda=mean(lambda)) %>%
#         ungroup()%>%
#         select(simulation,new_strategy,new_coverage,lambda,avg_lambda) %>%
#         left_join(sims_viz,by = c("simulation", "new_strategy", "new_coverage")) %>%
#         gather(type,value,-c(simulation,new_strategy, new_coverage, avg_lambda,coverage))%>%
#         ggplot(aes(x=new_strategy))+
#         geom_violin(aes(y=value,col=type,alpha=type),position="identity",fill="grey",
#                     trim=FALSE,scale="area")+
#         scale_color_manual(values=c("blue",NA),na.value = NA)+
#         scale_alpha_manual(values=c(0,0.3))+
#         geom_point(aes(y=avg_lambda),col="blue")+
#         facet_wrap(new_coverage~.)+
#         cowplot::theme_cowplot()+
#         theme(axis.text.x = element_text(angle=45,hjust = 1),
#               legend.position = "none"
#               )+
#         ylab("200-day seroincidence")+
#         xlab("Strategy")
# 
# 
# lambda_df  %>%
#         filter(adjustment== "Ignore", campaign_day == 21) %>%
#         mutate(new_coverage=factor(coverage,
#                                    labels=c("0% Coverage",
#                                             "25% Coverage",
#                                             "50% Coverage",
#                                             "75% Coverage"
#                                    )
#         )) %>%
#         group_by(new_coverage) %>%
#         summarize(lambda=glue::glue("{round(mean(lambda),3)} {round(min(lambda),3)}-{round(max(lambda),3)}")
#         )
# 
# 
# lambda_df  %>%
#         filter(campaign_day == 21 |
#                        (adjustment == "Ignore" & campaign_day == 120)|
#                        adjustment == "Alternative"
#         )%>%
#         mutate(new_strategy=paste(adjustment,campaign_day)) %>%
#         mutate(new_strategy = factor(new_strategy,
#                                      levels=c("Ignore 21", "Ignore 120",
#                                               "Questionnaire 21", "Alternative NA"
#                                      ),
#                                      labels=c("Original Model (21 days)", "Original Model (120 days)",
#                                               "Original Model + Questionnaire (21 days)", 
#                                               "Alternative Model 1 (21 days)")
#         )
#         ) %>%
#         filter(coverage==0.5) %>%
#         group_by(new_strategy) %>%
#         summarize(lambda=glue::glue("{round(mean(lambda),2)} {round(min(lambda),2)}-{round(max(lambda),2)}")
#                   )



```




### Methods

```{r}
read_rds("data/generated_data/quality_control/complete_raw_data.rds") %>%
        filter(subclass=="total")%>%
        count(Count<30) %>%
        mutate(percent=100*n/sum(n))


read_excel("data/raw_data/cohort_data/RIK Sero2 Electronic Lab Registry_ Sample inventory.xls") %>% View()

read_excel("data/raw_data/cohort_data/RIK Sero2 Electronic Lab Registry_ Sample inventory.xls") %>% 
    select(id=`RIK ID No.`,starts_with("Date of Day"))%>%
    gather(day,date,-id) %>%
        filter(!is.na(date))%>%
        count(id) %>%
        summarise(sum(n>=3),
                  mean(n>=3)
                  )

        
```


## Supplement


### Table S1. Timing of sample collection for each cohort


```{r eval=FALSE}

ts1 <- final_wide %>%
        group_by(cohort,status) %>%
        mutate(Individuals=length(unique(id)))%>% 
        count(cohort,status,Individuals,day) %>%
        mutate(n_percent=glue::glue("{n} ({round(n/Individuals*100)})")) %>%
        arrange(cohort,status)%>% 
        mutate(
                exposure= case_when(
                        cohort %in% c("BGD Vaccinee","HTI Vaccinee") ~"Vaccination with Shanchol",
                        cohort == "ETEC Challenge" ~ "Challenged with Enterotoxigenic E. coli",
                        status=="Case" ~ "Natural infection with V. cholerae O1",
                        status=="Contact" ~ "Household member of case-patient infected with V. cholerae O1"
                ),
                Population=case_when(
                        cohort =="BGD Vaccinee" ~ "Bangladeshi volunteer",
                        cohort =="SMIC/PIC" & status=="Case" ~ "Bangladeshi case-patient",
                        cohort =="SMIC/PIC" & status=="Contact" ~ "Bangladeshi volunteer",
                        cohort =="HTI Vaccinee" ~ "Haitian volunteer",
                        cohort == "ETEC Challenge" ~ "North American volunteer"
                )
                
        ) %>%
        ungroup()%>%
        select(
                `Exposure Type`= exposure,
                Population,
                `Days since exposure`=day,
                Individuals,
                `Samples (%)`=n_percent
        ) %>%
        flextable::flextable() %>%
        flextable::autofit() 


ts1


ts1 %>% flextable::save_as_docx( path = "figures/tables/supp_table_1.docx")





```

### Figure S1. Baseline comparison of IgG markers


```{r}

#keep
# raw_baseline_plot <- final_df %>%
#         filter((status=="Vaccinee" & day==0)|status=="Case" & day==2) %>%
#         filter(antigen_pretty %in% c("CT-B","Ogawa OSP","Inaba OSP","O139 OSP","TcpA")) %>%
#         mutate(`Age Group`=ifelse(age>=10,"Adults","Children")) %>%
#         mutate(`Age Group`=factor(`Age Group`,levels=c("Children","Adults"))) %>%
#         mutate(isotype=factor(isotype,levels=c("IgG","IgA","IgM")))%>%
#         mutate(pretty_cohort=ifelse(cohort=="SMIC/PIC",
#                                     "BGD Case",cohort
#                                     ))%>%
#         ggplot(aes(y=RAU_value,col=pretty_cohort,group=pretty_cohort,x=`Age Group`))+
#                 geom_boxplot()+
#                 scale_y_continuous("Baseline log10(1/RAU)",breaks = c(0.25,1,4)) +
#                 scale_color_brewer("Cohort",palette = "Set1")+
#                 facet_grid(isotype~antigen_pretty)+
#                 theme_bw()+
#                 theme(legend.position="bottom"
#                       )


final_df %>%
        filter((status=="Vaccinee" & day==0)|status=="Case" & day==2) %>%
        filter(antigen_pretty %in% c("CT-B","Ogawa OSP","Inaba OSP","O139 OSP","TcpA")) %>%
        mutate(`Age Group`=ifelse(age<10,"<10 years old",">= 10 years old")) %>%
 
        mutate(isotype=factor(isotype,levels=c("IgG","IgA","IgM")))%>%
        mutate(pretty_cohort=ifelse(cohort=="SMIC/PIC",
                                    "Bangladeshi Case",
                                    str_replace(cohort,"BGD","Bangladeshi")
                                    ))%>%
        mutate(pretty_cohort=str_replace(pretty_cohort,"HTI","Haitian"))%>%
        filter(isotype=="IgG")%>%
        ggplot(aes(y=RAU_value,col=pretty_cohort,group=pretty_cohort,x=pretty_cohort))+
                # geom_boxplot()+
                ggbeeswarm::geom_beeswarm(alpha=0.8,
                                          cex=3
                                          )+
                scale_y_continuous("Baseline IgG log10(1/RAU)"#,breaks = c(0.25,1,4)
                                   
                                   ) +
                xlab("Cohort")+
                scale_color_brewer("Cohort",palette = "Set1")+
                facet_grid(`Age Group`~antigen_pretty)+
                theme_bw()+
                theme(legend.position="none",
                      axis.text.x = element_text(angle=45,hjust=1)
                      )

# bootDF <- read_rds("data/generated_data/analysis_objects/describe/bootDF.rds")




# GMT_ratio_plot <- bootDF %>%
#         group_by(isotype,antigen_pretty,`Age Group`) %>%
#         summarize(mean=mean(RAU_ratio),
#                   lb=quantile(RAU_ratio,0.025),
#                   ub=quantile(RAU_ratio,0.975)) %>%
#         # mutate(`Age Group`=factor(`Age Group`,levels=c("<10 years old",">= 10 years old"))) %>%
#         ggplot(aes(x=`Age Group`, col=isotype,y=mean))+
#                 geom_point(position = position_dodge(0.5))+
#                 geom_linerange(aes(ymin=lb,ymax=ub),
#                                position = position_dodge(0.5))+
#         facet_wrap(.~antigen_pretty,nrow=1)+
#         geom_hline(yintercept=1,lty=2)+
#         theme_bw()+
#         scale_y_continuous("Geometric Mean\nRAU Ratio", trans="log2")+
#         xlab("Age Group")+
#         theme(
#               legend.position = "bottom",
#                       panel.grid.minor = element_blank(),
#                      panel.grid.major.x =  element_blank(),
# 
#               )+
#         scale_color_brewer("Isotype",palette = "Dark2")
# 
# 
# plot_grid(raw_baseline_plot,
#           GMT_ratio_plot,
#           rel_heights = c(2,1),
#           ncol=1,
#           align = "v",
#           axis="lr",
#           labels=c("A","B")
#           )
```


### Table S2. Geometric mean fold-rise in RAU by marker among cases and vaccines 

```{r}
baseline_sero_data <- final_df %>%
        filter((status=="Vaccinee" & day %in% c(0,3))|(status=="Case" & day==2)) %>%
        group_by(id) %>%
        filter(day ==min(day)) %>%
        # filter(!id %in% c("IMS_A018","IMS_B021")) %>%
        select(id,status,cohort,antigen_pretty,isotype,baseline=RAU_value)
                       

peak_sero_data <- final_df %>% 
        filter(status %in% c("Vaccinee","Case")) %>%
        filter(!((status=="Vaccinee" & day %in% c(0,3))|(status=="Case" & day==2))) %>%
        group_by(id,antigen_pretty,isotype) %>%
        slice_max(order_by=RAU_value,n=1,with_ties = FALSE) %>%
        ungroup()%>%
        # filter(!id %in% c("IMS_A018","IMS_B021"))%>%
        select(id,status,cohort,antigen_pretty,isotype,peak=RAU_value,day)


sero180_data <- final_df %>% 
        filter(status %in% c("Vaccinee","Case")) %>%
        filter(day %in% 180) %>%
        # filter(!id %in% c("IMS_A018","IMS_B021"))%>%
        select(id,status,cohort,antigen_pretty,isotype,day180=RAU_value,day)


# final_df %>% 
#         filter(status %in% c("Vaccinee","Case")) %>%
#         filter(day %in% c(42,44,30)) %>%
#         count(cohort,day) 

# peak_sero_data %>%
#         filter(antigen_pretty=="Ogawa OSP") %>%
#         group_by(cohort,isotype) %>%
#         mutate(lb=quantile(day,0.25),
#                   ub=quantile(day,0.75)
#                   ) %>%
#         group_by(cohort,isotype,lb,ub) %>%
#         summarise(n=n(),
#                   peaked=sum(day>=lb&day<=ub)
#                   )%>%
#         mutate(peaked/n) %>%
#         arrange(isotype)


ts2_pv <- baseline_sero_data %>%
        filter(antigen_pretty %in% c("CT-B","Ogawa OSP","Inaba OSP",
                                     "O139 OSP", "TcpA"
                                     ))%>%
        left_join(peak_sero_data) %>%
        mutate(diff=peak-baseline) %>% 
        filter(!is.na(diff))%>%
        group_by(antigen_pretty,isotype) %>%
        summarise(`p-value`=t.test(diff[status=="Case"],diff[status=="Vaccinee"])$p.value) %>%
        mutate(`p-value`=ifelse(`p-value`<0.01,"<0.01",as.character(round(`p-value`,2))))

ts2 <- baseline_sero_data %>%
        filter(antigen_pretty %in% c("CT-B","Ogawa OSP","Inaba OSP",
                                     "O139 OSP", "TcpA"
                                     ))%>%
        left_join(peak_sero_data) %>%
        mutate(diff=peak-baseline) %>% 
        filter(!is.na(diff))%>%
        group_by(antigen_pretty,isotype,status) %>%
        summarize(gmt=round(10^mean(diff),1)) %>% 
        ungroup() %>% 
        left_join(ts2_pv)%>%
        spread(status,gmt)%>%
        rename(Antigen=antigen_pretty,
               Isotype=isotype
               )%>%
        arrange(Antigen,Isotype)%>%
        select(Antigen,Isotype,Case,Vaccinee,`p-value`)%>%
        flextable::flextable() %>%
        flextable::autofit()


ts2 


ts2 %>% flextable::save_as_docx( path = "figures/tables/supp_table_2.docx")


```

### Table S3. Proportion of individuals with a two fold-rise in RAU by marker among cases and vaccines 


```{r}

ts3_pv <- baseline_sero_data %>%
        filter(antigen_pretty %in% c("CT-B","Ogawa OSP","Inaba OSP",
                                     "O139 OSP", "TcpA"
                                     ))%>%
        left_join(peak_sero_data) %>%
        mutate(diff=peak-baseline) %>% 
        filter(!is.na(diff))%>%
        group_by(antigen_pretty,isotype) %>%
        mutate(over2=10^(diff)>=2) %>%
        summarize(`p-value`=fisher.test(over2,status)$p.value)%>%
        mutate(`p-value`=ifelse(`p-value`<0.01,"<0.01",as.character(round(`p-value`,2))))


ts3 <- baseline_sero_data %>%
        filter(antigen_pretty %in% c("CT-B","Ogawa OSP","Inaba OSP",
                                     "O139 OSP", "TcpA"
                                     ))%>%
        left_join(peak_sero_data) %>%
        mutate(diff=peak-baseline) %>% 
        filter(!is.na(diff))%>%
        group_by(antigen_pretty,isotype,status) %>%
        summarize(pct=paste0(100*round(mean(10^(diff)>=2),2),"%")) %>% 
        ungroup() %>% 
        left_join(ts3_pv)%>%
        spread(status,pct)%>%
        rename(Antigen=antigen_pretty,
               Isotype=isotype
               )%>%
        arrange(Antigen,Isotype)%>%
        select(Antigen,Isotype,Case,Vaccinee,`p-value`)%>%
        flextable::flextable() %>%
        flextable::autofit()

ts3%>% flextable::save_as_docx( path = "figures/tables/supp_table_3.docx")

```


```{r}

#Something to investigate the 180 days

# baseline_sero_data %>%
#         filter(antigen_pretty %in% c("CT-B","Ogawa OSP","Inaba OSP",
#                                      "O139 OSP", "TcpA"
#                                      ))%>%
#         left_join(sero180_data)%>%
#         mutate(diff=day180-baseline) %>% 
#         filter(!is.na(diff)) %>%
#         group_by(antigen_pretty,isotype,status) %>%
#         summarize(gmt=round(10^mean(diff),1),
#                   `p-value`=round(t.test(diff)$p.value,2)
#                   ) %>%
#         mutate(`p-value`=ifelse(`p-value`<0.01,"<0.01",as.character(round(`p-value`,2))))%>%
#         mutate(new=paste0(gmt," (",`p-value`,")")) %>%
#         select(antigen_pretty,isotype,status,new)%>%
#         spread(status,new)%>%
#         rename(Antigen=antigen_pretty,
#                Isotype=isotype
#                )%>%
#         arrange(Antigen,Isotype)%>%
#         select(Antigen,Isotype,Case,Vaccinee)
#         





```



### Figure S2: Multidimensional scaling analysis of all serological data collected

```{r mds-code, eval=FALSE}

# multidimensional-scaling provides object with mds analysis
source("code/R/multidimensional-scaling.R")

```

```{r}
#get mds measurements
mds_obj <- read_rds("data/generated_data/analysis_objects/mds/mds_obj.rds")
permuted_distances <- read_rds("data/generated_data/analysis_objects/mds/permuted_distances.rds")

mds_obj %>%
        group_by(time_window,status) %>%
        summarise(avg_D1=mean(D1),
                  avg_D2=mean(D2)
                  ) %>%
        gather(dimension,value,-c(time_window,status)) %>%
        spread(status,value) %>%
        mutate(distance=(Case-Vaccinee)^2) %>%
        group_by(time_window) %>%
        summarise(euclidean=sqrt(sum(distance)))

permuted_distances %>%
        group_by(time_window) %>%
        summarize(quantile(euclidean,0.999))
centroids <- mds_obj %>%
                        group_by(time_window,status) %>%
                        summarize(D1=mean(D1),
                                  D2=mean(D2)
                                  )

mds_obj  %>%
        mutate(cohort=case_when(
                        cohort=="BGD Vaccinee" ~ "Bangladeshi Vaccinees",
                        cohort=="HTI Vaccinee" ~ "Haitian Vaccinees",
                        cohort=="SMIC/PIC" ~ "Bangladeshi Cases",

        ))%>%
                ggplot(aes(x=D1,y=D2,col=cohort)) +
                geom_point(aes(shape=cohort))+
                scale_color_manual("Cohort", values=c("red","#003262","#FDB515"))+
                scale_shape_manual("Cohort",values=c(2,1,1))+
                xlab("Dimension 1")+
                ylab("Dimension 2")+
        facet_wrap(.~time_window,scales="free")+
        theme_cowplot()+
        theme(legend.position = "bottom")

```



### Figure S3: Misclassification of vaccinees as seropositive by previous seroincidence models with additional markers using 45, 120, 200, and 300 day infection windows. 



```{r}


misclassify_df <- read_rds("data/generated_data/analysis_objects/misclassification/misclassify_df.rds")
tvfpr_df <- read_rds("data/generated_data/analysis_objects/misclassification/tvfpr_df.rds")


misclassify_df%>% filter(variables=="All Variables")%>%
        filter(cohort %in% c("HTI Vaccinee","BGD Vaccinee"))%>%
        filter(end_window %in% c("45"))%>%
        group_by(day,end_window,cohort) %>%
        summarize(seropos=sum(spec95_seropos),
                  n=n(),
                  )%>%
        mutate(per_pos=seropos/n) %>% 
        arrange(cohort)


filter(tvfpr_df,population== "All Vaccinees (All Variables)") %>%
        filter(end_window %in% c(120,200,300)) %>%
        group_by(end_window) %>%
        filter(median==max(median))



filter(tvfpr_df,population== "All Vaccinees (All Variables)") %>%
        filter(end_window %in% c(120,200,300)) %>%
        group_by(end_window) %>%
        filter(median>=0.05) %>%
        filter(time==min(time))

filter(tvfpr_df,population== "All Vaccinees (All Variables)") %>%
        filter(end_window %in% c(120,200,300)) %>%
        group_by(end_window) %>%
        filter(median>=0.05) %>%
        filter(time==max(time))


# filter(tvfpr_df,population== "All Vaccinees (All Variables [NO AGE])") %>%
#         filter(end_window %in% c(120,200,300)) %>%
#         filter(time>14)%>%
#         group_by(end_window) %>%
#         slice_min(abs(median-0.05),n=1)


misclassify_df%>% filter(variables=="All Variables")%>%
        filter(cohort %in% c("ETEC Challenge"))%>%
        filter(end_window %in% c("200"))%>%
        group_by(day,end_window,cohort) %>%
        summarize(seropos=sum(spec95_seropos),
                  n=n(),
                  )%>%
        mutate(per_pos=seropos/n) 



fs3<- misclassify_df %>% filter(variables=="All Variables")%>%
        filter(cohort %in% c("HTI Vaccinee","BGD Vaccinee"))%>%
        group_by(day,end_window,cohort) %>%
        summarize(seropos=mean(spec95_seropos))%>%
        filter(end_window %in% c("45","120","200","300"))%>%
        mutate(end_window=factor(end_window,
                        levels=c("45","120","200","300"),
                        labels=c("45-day","120-day","200-day","300-day")))%>%
        mutate(Vaccinee=case_when(
                        cohort=="BGD Vaccinee" ~ "Bangladeshi",
                        cohort=="HTI Vaccinee" ~ "Haitian"
        )) %>%
        ggplot()+
        geom_point(aes(col=Vaccinee,
                   y=seropos,x=day,shape=Vaccinee))+
        geom_line(data=filter(tvfpr_df,population== "All Vaccinees (All Variables)")%>%
                        mutate(end_window=factor(end_window,
                                 levels=c("45","120","200","300"),
                                 labels=c("45-day","120-day","200-day","300-day"))),
                        aes(x=time,y=median))+
        geom_ribbon(data=filter(tvfpr_df,population== "All Vaccinees (All Variables)")%>%
                        mutate(end_window=factor(end_window,
                                 levels=c("45","120","200","300"),
                                 labels=c("45-day","120-day","200-day","300-day"))),
                        aes(x=time,ymin=lb,ymax=ub),col=NA,
                                    alpha=0.2,
                        )+
        facet_grid(.~end_window)+
        theme_cowplot()+
        scale_x_continuous("Days since first dose",breaks=seq(0,365,90))+
        scale_y_continuous("Proportion Seroincident")+
        scale_color_manual(values = c("#003262","#FDB515"))+
        scale_shape_manual(values=c(1,1))+
        geom_hline(yintercept = 0.05,lty=2)+
        theme(legend.position = "bottom")
        
        
nmfp_label_df <- data.frame(
                end_window="45",
                X=270,
                Y=0.15
) %>% mutate(end_window=factor(end_window,
                                 levels=c("45","120","200","300"),
                                 labels=c("45-day","120-day","200-day","300-day")))
  
fs3 + geom_text(data=nmfp_label_df,
                label="Nominal false\npositivity rate",
                aes(x=X,y=Y),fontface="bold"
                )+
  geom_segment(data=nmfp_label_df,
               aes(xend = X, x = X,
               yend =Y-0.095,y=Y-0.05),
    arrow = arrow(length = unit(0.2,"cm"),
                  type="closed"
                  ))



```


### Figure S4: Comparison of performance of random forest models when serological data from vaccinees are included in the training set and additional markers. 


```{r }

#load the original model objects
tvfpr_df <- read_rds("data/generated_data/analysis_objects/misclassification/tvfpr_df.rds")
tvfpr_fit <- read_rds(
          paste0("data/generated_data/analysis_objects/misclassification/","tvfpr_fit.rds")
)

tvfpr_fit_200 <- tvfpr_fit$`200`$`All Vaccinees (All Variables)`

#load the new model objects

loocv_tvfit_df <- read_rds(
          paste0("data/generated_data/analysis_objects/loocv/","loocv_tvfit_df_new.rds")
)

loocv_tvfit_list <- read_rds(
          paste0("data/generated_data/analysis_objects/loocv/","loocv_tvfit_list_new.rds")
)

loocv_spec_df<- read_rds(
          paste0("data/generated_data/analysis_objects/loocv/","loocv_spec_df_new.rds")
)

loocv_df <- read_rds("data/generated_data/analysis_objects/loocv/loocv_df_new.rds")


p1 <- loocv_tvfit_df %>%
        filter(time<=200)%>%
        filter(population=="Vaccinee")%>%
        filter(str_detect(variables,"all"))%>%
        ggplot(aes(col=variables,fill=variables))+
                geom_line(aes(x=time,y=median))+
                geom_ribbon(aes(x=time,ymin=lb,ymax=ub),alpha=0.5,col=NA)+
                geom_line(data=tvfpr_df %>%
                                  filter(end_window==200)%>%
                                  filter(time<=200)%>%
                                  filter(population=="All Vaccinees (All Variables)"),
                          col="black",aes(x=time,y=median),lwd=1,
                          inherit.aes = FALSE
                          )+
        scale_color_manual(values = c("red","blue"))+
        scale_fill_manual(values = c("red","blue"))+
        xlab("Days since vaccination")+
        scale_y_continuous("False Positive Rate",limits = c(0,0.25))+
        geom_hline(yintercept = 0.05,lty=2,col="grey")+
        theme_cowplot()+
        theme(legend.position = "none")


p2_vax_df <- bind_rows(
        
        tvfpr_fit_200$out_df %>%
        filter(time<=200) %>% group_by(.draw)%>%
        summarize(avg=mean(theta)) %>%
        ungroup()%>%
        summarize(median=median(avg),
                  lb=quantile(avg,0.025),
                  ub=quantile(avg,0.975)
                  )%>%
        mutate(variables="original"),


        loocv_tvfit_list$all_2class$all_fitdata$`200-day`$Vaccinee$out_df %>%
        filter(time<=200) %>% group_by(.draw)%>%
        summarize(avg=mean(theta)) %>%
        ungroup()%>%
        summarize(median=median(avg),
                  lb=quantile(avg,0.025),
                  ub=quantile(avg,0.975)
                  )%>%
        mutate(variables="all_2class"),


        loocv_tvfit_list$all_3class$all_fitdata$`200-day`$Vaccinee$out_df %>%
        filter(time<=200)%>% group_by(.draw)%>%
        summarize(avg=mean(theta)) %>%
        ungroup()%>%
        summarize(median=median(avg),
                  lb=quantile(avg,0.025),
                  ub=quantile(avg,0.975)
                  ) %>%
                mutate(variables="all_3class")
) %>% mutate(population="Vaccinated")  

p2_outside_df <- loocv_spec_df %>% 
                        filter(str_detect(variables,"all")) %>%
                        filter(population=="Outside Window") %>%
                        mutate(variables=ifelse(base_data_name=="case_fitdata",
                                                "original",variables
                                                )) %>%
                        mutate(median=1-median,
                               lb_new=1-ub,
                               ub=1-lb
                               )%>%
                        select(median,lb=lb_new,ub,variables,population)%>%
                        mutate(population="Unvaccinated")

p2<- bind_rows(p2_outside_df,p2_vax_df)%>%
        mutate(Model=factor(variables,
                            levels=c("original","all_2class","all_3class"),
                             labels=c("Infection-Only model",
                                     "Mixed-Cohort\nTwo Class model",
                                     "Mixed-Cohort\nThree Class model"
                                     )
                            )) %>%
        mutate(population=factor(population))%>%
        mutate(population=fct_rev(population))%>%
        ggplot()+
                geom_point(aes(x=population,y=median,col=Model),
                           position = position_dodge(0.5)
                           )+
                geom_linerange(aes(x=population,ymin=lb,ymax=ub,col=Model),
                           position = position_dodge(0.5)
                           )+
        theme_cowplot()+
        geom_hline(yintercept = 0.05,lty=2,col="grey")+
        scale_color_manual(values = c("black","red","blue"))+
        scale_y_continuous("False Positive Rate",limits = c(0,0.25))+
        xlab("Population")

p3_df <- loocv_tvfit_df %>%
        filter(population=="Case")%>%
        filter(str_detect(variables,"all"))%>%
                        mutate(variables=ifelse(base_data_name=="case_fitdata",
                                                "original",variables
                                                )) %>%
        filter(time<=200)




p3 <- p3_df%>%
        filter(str_detect(variables,"all"))%>%
        ggplot(aes(col=variables,fill=variables))+
                geom_line(aes(x=time,y=median))+
                geom_ribbon(aes(x=time,ymin=lb,ymax=ub),alpha=0.5,col=NA)+
        geom_line(data=p3_df %>%
                          filter(variables=="original"),
                  col="black",aes(x=time,y=median), lwd=1,
                  inherit.aes = FALSE
                  )+
        scale_color_manual(values = c("red","blue"))+
        scale_fill_manual(values = c("red","blue"))+
        xlab("Days since infection")+
        scale_y_continuous("Sensitivity",limits=c(0,1))+
        theme_cowplot()+
        theme(legend.position = "none")

p4 <- loocv_df %>%
        filter(variables=="all_3class") %>%
        mutate(across(Neither:RecentlyVaccinated,.fns = ~ifelse(is.na(.x),
                                                                0,.x
                                                                ))) %>%
        mutate(prediction=case_when(
                Neither >= RecentlyInfected & Neither >=RecentlyVaccinated ~"Neither",
                RecentlyInfected > Neither & RecentlyInfected >= RecentlyVaccinated ~"RecentlyInfected",
                RecentlyVaccinated > Neither & RecentlyVaccinated > RecentlyInfected ~"RecentlyVaccinated"
        )) %>%
        mutate(three_class=factor(three_class),
                  prediction=factor(prediction)
        ) %>%
        count(variables,three_class,prediction,.drop=FALSE) %>%
        group_by(variables,three_class) %>%
        mutate(proportion=n/sum(n)) %>%
        mutate(three_class=str_replace(three_class,"Recently","Recently\n"))%>%
        mutate(three_class=glue::glue("{three_class}\n(n={sum(n)})"))%>%
        mutate(prediction=str_replace(prediction,"Recently","Recently "))%>%
        ggplot(aes(x=three_class,y=prediction))+
        geom_tile(aes(fill=100*proportion))+
        geom_text(aes(label=paste0(100*round(proportion,2),"%")))+
        scale_fill_distiller("Percent\nClassified",palette = "Blues",
                             direction = 1,limits=c(0,100),
        )+
        xlab("True Class")+
        ylab("Predicted Class")+
        theme_cowplot()


plot_grid(
        plot_grid(p1,p2,nrow=1,rel_widths = c(1,1), labels=c("A","B")),
        plot_grid(p3,p4,nrow = 1,rel_widths = c(1,1), labels=c("C","D")),
        nrow=2
        )
```





##OLD STUFF

```{r loocv-code, eval=FALSE}

source("loocv.R")

```


```{r avg-sens}

loocv_tvfit_list <- read_rds(
          paste0("data/generated_data/analysis_objects/loocv/","loocv_tvfit_list.rds")
)

tvsens_draws <- bind_rows(
        loocv_tvfit_list$`Reduced IgG Panel`$smicpic_fitdata$`200-day`$Case$out_df %>%
                mutate(model="Original Model"),
        loocv_tvfit_list$`Reduced IgG Panel`$all_fitdata$`200-day`$Case$out_df %>%
                mutate(model="Alternative Model 1"),
        loocv_tvfit_list$`All Variables`$all_fitdata$`200-day`$Case$out_df %>%
                mutate(model="Alernative Model 2")
        )%>%
        filter(time<=200)

tvsens_draws %>%
        group_by(.draw,model) %>%
        summarize(avg_sens=mean(theta)) %>%
        group_by(model)%>%
        summarize(median=round(100*median(avg_sens)),
                  lb=round(100*quantile(avg_sens,0.025)),
                  ub=round(100*quantile(avg_sens,0.975))
                  )


```


```{r loocv-figure, eval=TRUE,fig.width=6,fig.height=10}

#variable list
#variable list
var_list <- list(
        `Reduced IgG Panel` = c("RAU_IgG_CtxB","RAU_IgG_InabaOSPBSA","RAU_IgG_OgawaOSPBSA"),
        `All Variables`= data.frame(marker=colnames(final_wide)) %>%
                filter(str_detect(marker,"CtxB|Ogawa|Inaba|TcpA|IgG_O139")) %>%
                unlist()  %>% unname(),
        `Reduced IgG Panel (and age)` = c("RAU_IgG_CtxB","RAU_IgG_InabaOSPBSA","RAU_IgG_OgawaOSPBSA", "age"),
        `All Variables (and age)`= data.frame(marker=colnames(final_wide)) %>%
                filter(str_detect(marker,"CtxB|Ogawa|Inaba|TcpA|IgG_O139")) %>%
                unlist() %>% c("age") %>% unname()
)

tree_param <- 1000

#get permutation importance
importance<- ranger::ranger(data=final_wide %>%
                filter(cohort %in% c("SMIC/PIC","BGD Vaccinee","HTI Vaccinee"))%>%
                                    addInfectionWindow(end_window=200),
                            formula=make_formula("inf_200",var_list[["All Variables"]]),
                            num.trees= tree_param,
                            case.weights = NULL,
                            importance = "permutation"
)

importance$variable.importance %>% sort()

#get permutation importance
importance<- ranger::ranger(data=final_wide %>%
                filter(cohort %in% c("SMIC/PIC","BGD Vaccinee","HTI Vaccinee"))%>%
                                    addInfectionWindow(end_window=200),
                            formula=make_formula("inf_200",var_list[["Reduced IgG Panel"]]),
                            num.trees= tree_param,
                            case.weights = NULL,
                            importance = "permutation"
)
importance$variable.importance%>% sort()



f3_loocv_df <- read_rds("data/generated_data/analysis_objects/loocv/loocv_df.rds") %>%
        ### limit to the correct data and variables 
        filter(base_data_name %in% c("smicpic_fitdata","all_fitdata"))%>%
        filter(variables %in% c("Reduced IgG Panel","All Variables"))%>%
        #remove the all variables model for just smic/pic data
        filter(!(base_data_name=="smicpic_fitdata" & variables== "All Variables")) %>%
        mutate(new_modelname=case_when(
                base_data_name == "smicpic_fitdata" &variables == "Reduced IgG Panel" ~ "Original Model",
                base_data_name == "all_fitdata" &variables == "Reduced IgG Panel" ~ "Alternative Model 1",
                base_data_name == "all_fitdata" &variables == "All Variables"~ "Alternative Model 2"
        )) %>%
        mutate(new_modelname=factor(new_modelname,levels=c(
                                                           "Alternative Model 1",
                                                           "Alternative Model 2",
                                                           "Original Model"
                                                           ))) 


f3_tvfit_df <- read_rds("data/generated_data/analysis_objects/loocv/loocv_tvfit_df.rds") %>%
        ### limit to the correct data and variables 
        filter(base_data_name %in% c("smicpic_fitdata","all_fitdata"))%>%
        filter(variables %in% c("Reduced IgG Panel","All Variables"))%>%
        #remove the all variables model for just smic/pic data
        filter(!(base_data_name=="smicpic_fitdata" & variables== "All Variables")) %>%
        mutate(new_modelname=case_when(
                base_data_name == "smicpic_fitdata" &variables == "Reduced IgG Panel" ~ "Original Model",
                base_data_name == "all_fitdata" &variables == "Reduced IgG Panel" ~ "Alternative Model 1",
                base_data_name == "all_fitdata" &variables == "All Variables"~ "Alternative Model 2"
        )) %>%
        mutate(new_modelname=factor(new_modelname,levels=c(
                                                           "Alternative Model 1",
                                                           "Alternative Model 2",
                                                           "Original Model"
                                                           ))) 

f3_spec_df <- read_rds( paste0("data/generated_data/analysis_objects/loocv/","loocv_spec_df.rds"))%>%
        ### limit to the correct data and variables 
        filter(base_data_name %in% c("smicpic_fitdata","all_fitdata"))%>%
        filter(variables %in% c("Reduced IgG Panel","All Variables"))%>%
        #remove the all variables model for just smic/pic data
        filter(!(base_data_name=="smicpic_fitdata" & variables== "All Variables")) %>%
        mutate(new_modelname=case_when(
                base_data_name == "smicpic_fitdata" &variables == "Reduced IgG Panel" ~ "Original Model",
                base_data_name == "all_fitdata" &variables == "Reduced IgG Panel" ~ "Alternative Model 1",
                base_data_name == "all_fitdata" &variables == "All Variables"~ "Alternative Model 2"
        )) %>%
        mutate(new_modelname=factor(new_modelname,levels=c(
                                                           "Alternative Model 1",
                                                           "Alternative Model 2",
                                                           "Original Model"
                                                           ))) %>%
        mutate(population=ifelse(
                population =="Vaccinee",
                "Vaccinated", "Unvaccinated"

        )) 

f3_spec_df %>%
        mutate(
               median=round(100*median), 
               lb=round(100*lb),
               ub=round(100*ub)) %>%
        select(new_modelname,population,median,lb,ub)

# f3a <- f3_loocv_df %>%
#         filter(cohort=="SMIC/PIC") %>%
#         ggplot(alpha=0.7)+ 
#         plotROC::geom_roc(aes(m = prediction, d = as.numeric(as.character(inf_200)), col=new_modelname),labels=FALSE,n.cuts=0)+ 
#         geom_abline(lty=3,col="grey50")+
#         xlab("False Positivity Rate")+
#         ylab("True Positivity Rate")+
#         scale_color_brewer("Model",palette ="Dark2")+
#         theme_cowplot()
# 
# f3b <- f3_loocv_df %>%
#         filter(base_data_name=="all_fitdata")%>%
#         ggplot()+ 
#         plotROC::geom_roc(aes(m = prediction, d = as.numeric(as.character(inf_200)),
#                               col=new_modelname),labels=FALSE,n.cuts=0
#                           )+ 
#         geom_abline(lty=3,col="grey50")+
#         xlab("False Positivity Rate")+
#         ylab("True Positivity Rate")+
#         scale_color_brewer("Model",palette ="Dark2")+
#         theme_cowplot()

f3a <- f3_loocv_df %>%
        ggplot()+ 
        plotROC::geom_roc(aes(m = prediction, d = as.numeric(as.character(inf_200)),
                              col=new_modelname),labels=FALSE,n.cuts=0
                          )+ 
        geom_abline(lty=3,col="grey50")+
        xlab("False Positivity Rate")+
        ylab("True Positivity Rate")+
        scale_color_brewer("Model",palette ="Dark2")+
        theme_cowplot()



plotROC::calc_auc(f3a)

f3c <- f3_loocv_df %>%
        filter(inf_200==1)%>%
        group_by(new_modelname,day) %>%
        summarize(seropos=mean(spec95_seropos))  %>%      
        ggplot(aes(col=new_modelname,fill=new_modelname))+
                geom_point(aes(x=day,y=seropos),shape=1)+
                geom_line(data=filter(f3_tvfit_df,population== "Case",time<200),aes(x=time,y=median))+
                geom_ribbon(data=filter(f3_tvfit_df,population== "Case",time<200),
                            aes(x=time,ymin=lb,ymax=ub),col=NA,
                                            alpha=0.2
                                )+
                facet_grid(.~new_modelname,scales="free_x",space="free")+
                scale_color_brewer("Model",palette ="Dark2")+
                scale_fill_brewer("Model",palette ="Dark2")+
                theme_bw()+
                theme(  panel.grid.major.x=element_blank(),
                        panel.grid.minor =element_blank(),
                        )+
                ylab("Sensitivity")+
                xlab("Days after symptom onset")

f3d <- f3_spec_df %>%
        ggplot()+
                geom_point(aes(x=population,y=median,col=new_modelname))+
                geom_linerange(aes(x=population,ymin=lb,ymax=ub,col=new_modelname))+
                scale_color_brewer("Model",palette ="Dark2")+
                theme_bw()+
                theme(  panel.grid.major.x=element_blank(),
                        panel.grid.minor =element_blank(),
                        axis.text.x = element_text(angle=45,hjust = 1)
                        )+
                geom_hline(yintercept = 0.95,lty=2)+
        facet_grid(.~new_modelname,scales="free_x")+
        scale_y_continuous("Specificity",limits=c(0.85,1))+
        xlab("Population")
        

f3_spec_df

# plot_grid(f3a+ggtitle("Cases and uninfected\ncontacts only")+
#                   theme(legend.position = c(0.25,0.4),
#                         legend.background = element_rect(fill = "white",color = "black"))
#                   ,
#           f3b+ggtitle("All samples")+
#                   theme(legend.position ="none"),nrow=1,align="h",
#                   labels = c("A","B")) %>%
#         plot_grid(f3c+theme(legend.position ="none"),
#                   f3d+theme(legend.position ="none"),ncol=1,
#                   labels = c("","C","D")
#                   )


plot_grid(
        plot_grid(f3a+#ggtitle("Cases and uninfected\ncontacts only")+
                  theme(legend.position = c(0.25,0.4),
                        legend.background = element_rect(fill = "white",color = "black")),
                  ggplot()+
                          theme_void(),
                  rel_widths = c(2,1)
                  ),
        f3c+theme(legend.position ="none"),
        f3d+theme(legend.position ="none"),ncol=1,
                  labels = c("A","B","C"),
                  rel_heights = c(3,2,2.5)
                  )



# loocv_df %>%
#         filter(status=="Case")%>%
#                 filter(base_data_name!="bgd_fitdata")%>%
#         group_by(variables,day,base_data_name,status,inf_200)%>%
#         summarize(seropos=mean(spec95_seropos)) %>%
#         ggplot(aes(x=factor(day),fill=inf_200,y=seropos))+
#         geom_col(position=position_dodge2())+
#         facet_grid(paste(variables,base_data_name)~.,scales="free_x",space="free")+
#         geom_hline(yintercept = 0.05,lty=2)+
#         theme_cowplot()+
#         xlab("Day")+
#         ylab("Seropositivity")+
#         scale_fill_brewer("Model",palette="Dark2")+
#         theme(axis.text.x = element_text(hjust=1,angle=45),
#               legend.position = "none")
# 
# 
# 
# loocv_df %>%
#         filter(status=="Vaccinee")%>%
#         filter(base_data_name=="all_fitdata")%>%
#         group_by(variables,day,base_data_name,status)%>%
#         summarize(seropos=mean(spec95_seropos)) %>%
#         ggplot(aes(x=factor(day),fill=variables,y=seropos))+
#         geom_col(position=position_dodge2())+
#         facet_grid(status~paste(variables,base_data_name),scales="free_x",space="free")+
#         geom_hline(yintercept = 0.05,lty=2)+
#         theme_cowplot()+
#         xlab("Day")+
#         ylab("Seropositivity")+
#         scale_fill_brewer("Model",palette="Dark2")+
#         cowplot::theme_cowplot()+
#         theme(axis.text.x = element_text(hjust=1,angle=45),
#               legend.position = "none")
# 
# filter(loocv_tvfit_df,population== "Vaccinee") %>%
#         filter(base_data_name!="bgd_fitdata")%>%
#         ggplot()+
#                 geom_line(aes(x=time,y=median,col=paste(base_data_name,variables)))+
#                 geom_ribbon( aes(x=time,y=median,ymin=lb,ymax=ub,fill=paste(base_data_name,variables)),col=NA,
#                                             alpha=0.2
#                                 )+
#                 cowplot::theme_cowplot()+
#                 geom_hline(yintercept = 0.05,lty=2)+
#                 scale_y_continuous(limits=c(0,1))+
#         xlab("Day")+
#         ylab("Seropositivity")
        
                #geom_vline(xintercept = 200)

# f3a <- loocv_df %>%
#         ggplot()+ 
#         plotROC::geom_roc(aes(m = prediction, d = as.numeric(as.character(inf_200)), col=variables),labels=FALSE,n.cuts=0)+ 
#         geom_abline(lty=3,col="grey50")+
#         xlab("False Positivity Rate")+
#         ylab("True Positivity Rate")+
#         scale_color_brewer("Model",palette ="Dark2")+
#         theme_cowplot()+
#         theme(legend.position = "none")
# 
# plotROC::calc_auc(f3a)
# 
# 
# f3b <- loocv_df %>%
#         group_by(variables,day,status)%>%
#         summarize(seropos=mean(spec95_seropos)) %>%
#         ggplot(aes(x=factor(day),fill=variables,y=seropos))+
#         geom_col(position=position_dodge2())+
#         facet_grid(.~status,scales="free_x",space="free")+
#         geom_hline(yintercept = 0.05,lty=2)+
#         theme_cowplot()+
#         xlab("Day")+
#         ylab("Seropositivity")+
#         scale_fill_brewer("Model",palette="Dark2")+
#         theme(axis.text.x = element_text(hjust=1,angle=45),
#               legend.position = "none")
# 
# 
# external_df <- read_rds("data/generated_data/external_df.rds")
# 
# 
# f3c <- external_df %>%
#         filter(training_set == "Vax included" | variables=="Reduced IgG Panel") %>%
#         mutate(variables=ifelse(training_set=="No vax included",
#                                 "Original",variables
#                                 )) %>%
#         group_by(variables,day,cohort)%>%
#         summarize(seropos=mean(spec95_seropos)) %>%
#         mutate(variables=factor(variables,
#                                 levels=c(
#                                          
#                                          "All Variables",
#                                          "Reduced IgG Panel",
#                                          "Original"
#                                          ))) %>%
#         mutate(variables=fct_rev(variables))%>%
#         ggplot(aes(x=factor(day),fill=variables,y=seropos))+
#         geom_col(position=position_dodge2())+
#         geom_hline(yintercept = 0.05,lty=2)+
#         theme_cowplot()+
#         xlab("Day")+
#         ylab("Seropositivity"               )+
#         scale_fill_brewer("Model",palette="Dark2",direction = -1)+
#         theme(axis.text.x = element_text(hjust=1,angle=45))
# 
# plot_grid(f3a,f3b, f3c, ncol = 1,labels = c("A","B","C"))

```

### Figure 5: Model performance to distinguish recently infected individuals, recently vaccinated individuals, and individuals neither recently infected nor vaccinated. 

Samples of recently infected individuals were collected between 5 and 200 days after symptom onset. Samples of recently vaccinated individuals (from Bangladesh and Haiti) were collected between 5 and 200 days after the first dose was given. Samples of individuals who were neither recently infected nor vaccinated were from Bangladeshi cases, Bangladeshi uninfected contacts, Bangladeshi vaccinees, and Haitian vaccinees. 


```{r threeclass-code, eval=FALSE}

source("code/R/loocv_3class.R")

```

```{r threeclass-figure, eval=TRUE,fig.width=5.5,fig.height=9}


loocv_3class_df <- read_rds("data/generated_data/analysis_objects/loocv/loocv_3class_df.rds")




loocv_3class_df %>% filter(variables=="Reduced IgG Panel") %>%
        group_by(three_class) %>%
        summarize(samples=n(),
                  individuals=length(unique(id))
                  )

loocv_3class_df %>%
        filter(variables %in% c("All Variables","Reduced IgG Panel"))%>%
        mutate(three_class=str_replace(three_class,"Recently","Recently\n"))%>%
        mutate(prediction=str_replace(prediction,"Recently","Recently "))%>%
        mutate(prediction=factor(prediction)) %>%
        group_by(variables,three_class) %>%
        mutate(Days=paste0(sort(unique(day)),collapse = ", ")) %>%
        group_by(variables,three_class,Days,prediction,.drop=FALSE) %>%
        summarize(n=n(),
                  ) %>%
        group_by(variables,three_class,Days)%>%
        mutate(n=glue::glue("{n}/{sum(n)} ({100*(round(n/sum(n),2))}%)")) %>%
        spread(prediction,n) %>%
        rename(`Observed Class`=three_class,
               Model=variables) %>%
        flextable::flextable() %>%
        flextable::autofit()



loocv_3class_df %>%
        filter(variables %in% c("All Variables","Reduced IgG Panel"))%>%
        mutate(three_class=factor(three_class),
               prediction=factor(prediction)
               ) %>%
        count(variables,three_class,prediction,.drop=FALSE) %>%
                group_by(variables,three_class) %>%
                mutate(proportion=n/sum(n)) %>%
        mutate(three_class=str_replace(three_class,"Recently","Recently\n"))%>%
        mutate(three_class=glue::glue("{three_class}\n(n={sum(n)})"))%>%
        mutate(prediction=str_replace(prediction,"Recently","Recently "))%>%
        ggplot(aes(x=three_class,y=prediction))+
                geom_tile(aes(fill=100*proportion))+
                facet_wrap(.~variables)+
                geom_text(aes(label=paste0(100*round(proportion,2),"%")))+
        scale_fill_distiller("Percent\nClassified",palette = "Oranges",
                             direction = 1
                             )+
        xlab("True Class")+
        ylab("Predicted Class")+
        theme_cowplot()
        # theme(axis.text.x = element_text(angle=45,hjust=1))

# confusion_matrix_df <- read_rds("data/generated_data/loocv_3class_df.rds") %>%
#         count(variables,three_class,prediction) %>%
#                 group_by(variables,three_class) %>%
#                 mutate(proportion=n/sum(n)) %>%
#         mutate(three_class=str_replace(three_class,"Recently","Recently\n"))%>%
#         mutate(prediction=str_replace(prediction,"Recently","Recently "))
# 
# 
# confusion_plot <- confusion_matrix_df %>%
#         ggplot(aes(x=three_class,y=prediction))+
#                 geom_tile(aes(fill=100*proportion))+
#                 facet_wrap(.~variables)+
#                 geom_text(aes(label=scales::percent(round(proportion,2),1)))+
#         scale_fill_distiller("Percent\nClassified",palette = "Oranges",direction = 1)+
#         xlab("Observed Class")+
#         ylab("Predicted Class")+
#         theme_cowplot()
# 
# 
# incidence_lvls <- c(0.05,0.10,0.15)
# coverage_lvls <- seq(0,1,0.02)
# 
# 
# # sens3_df <- confusion_matrix_df %>%
# #         mutate(three_class=str_replace(three_class,"\n"," ")) %>%
# #         select(variables,three_class,prediction,proportion)  %>%
# #         filter(three_class==prediction) %>%
# #         select(variables,three_class,sensitivity=proportion)
# 
# #get class level sensitivity and specificity
# class_pred_df <- data.frame()
# for( class in c("Recently Infected", "Recently Vaccinated","Neither")){
#         
#         class_pred_df <- bind_rows(
#                 class_pred_df,
#                 confusion_matrix_df %>%
#         mutate(three_class=str_replace(three_class,"\n"," ")) %>%
#         select(variables,three_class,prediction,proportion)  %>%
#         spread(prediction,proportion) %>%
#         mutate(percent= ifelse(three_class==class,
#                                !!sym(class),
#                                1 - !!sym(class))) %>%
#         mutate(prediction=class) %>%
#         mutate(parameter=ifelse(three_class==class,
#                                 "sensitivity","class_specificity"
#                                 ))%>%
#         select(variables,three_class, prediction,percent,parameter)
#                 
#         )        
#         
# }
# 
# #get sensitivity df
# sens_df <- class_pred_df %>% filter(parameter=="sensitivity") %>%
#         spread(parameter,percent) %>%
#         select(-three_class)
# #get specificity df
# spec_df <- class_pred_df %>% filter(parameter=="class_specificity") %>%
#         select(variables,three_class,prediction,percent) %>%
#         spread(three_class,percent) %>%                       
#         expand_grid(incidence=incidence_lvls,coverage=coverage_lvls) %>%
#         mutate(vax_notinf=coverage*(1-incidence),
#                notboth=1-incidence-vax_notinf
#                ) %>% 
#         mutate(specificity=case_when(
#                 prediction=="Neither" ~ (`Recently Infected`*incidence + `Recently Vaccinated`*vax_notinf)/(incidence+vax_notinf),
#                 prediction=="Recently Infected" ~ (Neither*notboth + `Recently Vaccinated`*vax_notinf)/(notboth+vax_notinf),
#                 prediction=="Recently Vaccinated" ~ (Neither*notboth + `Recently Infected`*incidence)/(notboth+incidence)
#         )) %>%        
#         select(-Neither,-`Recently Infected`,-`Recently Vaccinated`)
# 
# 
# spec_df %>%filter(coverage==0.5) %>%
#         # filter(variables=="All Variables") %>%
#         filter(incidence==0.1)
# 
# 
# #calculate PPV and NPV
# PV_df <- left_join(sens_df,spec_df)  %>%
#         mutate(
#                 PPV= case_when(
#                         prediction=="Neither"~ notboth*sensitivity/(notboth*sensitivity + (1-notboth)*(1-specificity)) ,
#                         prediction=="Recently Infected"~ incidence*sensitivity/(incidence*sensitivity + (1-incidence)*(1-specificity)),
#                         prediction=="Recently Vaccinated"~vax_notinf*sensitivity/(vax_notinf*sensitivity + (1-vax_notinf)*(1-specificity))
#                        ),
#                 NPV= case_when(
#                         prediction=="Neither"~ (1-notboth)*specificity/(notboth*(1-sensitivity) + (1-notboth)*(specificity)) ,
#                         prediction=="Recently Infected"~ (1-incidence)*specificity/(incidence*(1-sensitivity) + (1-incidence)*(specificity)),
#                         prediction=="Recently Vaccinated"~ (1-vax_notinf)*specificity/(vax_notinf*(1-sensitivity) + (1-vax_notinf)*(specificity))
#                        )
# 
#         )
# 
# 
# PV_df %>% filter(variables=="All Variables") %>%
#         filter(incidence==0.1) %>%
#         filter(prediction=="Recently Infected") %>%
#         summarize(min(PPV),
#                   max(PPV),
#                   min(NPV),
#                   max(NPV)
#                   )
# 
# PV_df %>% filter(variables=="All Variables") %>%
#         filter(incidence==0.1) %>%
#         filter(prediction=="Recently Vaccinated") %>%
#         mutate(combo=PPV+NPV) %>%
#         filter(combo==max(combo))
# 
# 
# pred_value_plot <- PV_df %>%
#         filter(incidence==0.1)%>%
#         select(variables,prediction,incidence,coverage,PPV,NPV) %>%
#         pivot_longer(c(PPV,NPV),
#                      names_to = "Predictive Value",
#                      values_to = "Percent"
#                      ) %>%
#         ggplot(aes(x=coverage*100,y=Percent*100,col=`Predictive Value`,
#                    lty=variables
#                    ))+
#                 geom_line()+
#                 facet_grid(.~prediction)+
#                 theme_cowplot()+
#                 ylab("Percent")+
#                 xlab("Coverage (%)")+
#                 scale_linetype_discrete("Model")+
#                 theme(legend.position = "bottom")
# 
# plot_grid(
#         confusion_plot,pred_value_plot,ncol=1,
#         labels = c("A","B")
#         
# )

```


## ROC comparison

```{r}
roc_1  <- f3_loocv_df %>%
        filter(cohort=="SMIC/PIC") %>%
        ggplot(alpha=0.7)+ 
        plotROC::geom_roc(aes(m = prediction, d = as.numeric(as.character(inf_200)), col=new_modelname),labels=FALSE,n.cuts=0)+ 
        geom_abline(lty=3,col="grey50")+
        xlab("False Positivity Rate")+
        ylab("True Positivity Rate")+
        scale_color_brewer("Model",palette ="Dark2")+
        theme_cowplot()

roc_2 <- f3_loocv_df %>%
        ggplot()+ 
        plotROC::geom_roc(aes(m = prediction, d = as.numeric(as.character(inf_200)),
                              col=new_modelname),labels=FALSE,n.cuts=0
                          )+ 
        geom_abline(lty=3,col="grey50")+
        xlab("False Positivity Rate")+
        ylab("True Positivity Rate")+
        scale_color_brewer("Model",palette ="Dark2")+
        theme_cowplot()


plot_grid(roc_1,roc_2)

plot_grid(roc_1+ggtitle("Cases and uninfected\ncontacts only")+
                  theme(legend.position = c(0.25,0.4),
                        legend.background = element_rect(fill = "white",color = "black"))
                  ,
          roc_2+ggtitle("All samples")+
                  theme(legend.position ="none"),nrow=1,align="h",
                  labels = c("A","B"))


```


### Three class table

```{r eval=FALSE}

loocv_3class_df <- read_rds("data/generated_data/loocv_3class_df.rds")


loocv_3class_df %>%
        mutate(three_class=str_replace(three_class,"Recently","Recently\n"))%>%
        mutate(prediction=str_replace(prediction,"Recently","Recently "))%>%
        mutate(prediction=factor(prediction)) %>%
        group_by(variables,three_class,cohort,status) %>%
        mutate(Days=paste0(sort(unique(day)),collapse = ", ")) %>%
        group_by(variables,three_class,cohort,status,Days,prediction,.drop=FALSE) %>%
        summarize(n=n(),
                  ) %>%
        group_by(variables,three_class,cohort,status,Days)%>%
        mutate(n=glue::glue("{n}/{sum(n)} ({100*(round(n/sum(n),2))}%)")) %>%
        spread(prediction,n) %>%
        rename(`Observed Class`=three_class,
               Model=variables) %>%
        flextable::flextable() %>%
        flextable::autofit()

```


```{r}


ss_df <- proportion_15 %>%
                group_by(pred,obs) %>%
                count() %>%
                group_by(obs) %>%
                mutate(prop=n/sum(n))%>%
        mutate(obs_vax=ifelse(obs=="RecentlyVaccinated",
                              "Vaxxed","NotVaxxed"
                              ),
               pred_vax=ifelse(pred=="RecentlyVaccinated",
                              "Vaxxed","NotVaxxed"
                              ))%>% 
        group_by(pred_vax,obs,obs_vax) %>%
        summarize(prop=sum(prop)) %>%
        ungroup()%>%
        filter(pred_vax==obs_vax) %>%
        select(-obs_vax,-pred_vax) %>%
        spread(obs,prop) %>%
        mutate(
                # low_inc=0.01,
                # high_inc = 0.3
                med_inc = 0.05
        ) %>%
        gather(setting,inc,-c(RecentlyVaccinated,RecentlyInfected,Neither)) #%>%
        # mutate(sens=RecentlyVaccinated,
        #        spec=inc*RecentlyInfected+(1-inc)*Neither
        #        )



ppv_df <- data.frame(cov=seq(0,0.95,.01)) %>%
                expand_grid(ss_df) %>%
        mutate(sens=RecentlyVaccinated,
               spec=(inc*RecentlyInfected+(1-inc-cov)*Neither)/(1-cov)
               ) %>%
        mutate(ppv=cov*sens/(cov*sens+(1-cov)*(1-spec)),
               npv=(1-cov)*spec/(cov*(1-sens)+(1-cov)*(spec))
                             ) %>%
                select(cov,inc,ppv,npv)


ppv_df %>% mutate(sum_pv=npv+ppv) %>%
                filter(sum_pv==max(sum_pv))


PPV_plot <- ppv_df%>%
        gather(pv,value,-c(cov,inc))%>%
        ggplot(aes(x=cov*100,y=value*100,col=pv))+
                # geom_vline(xintercept = ppv_df %>% mutate(sum_pv=npv+ppv) %>%
                #                 filter(sum_pv==max(sum_pv)) %>% pull(cov)*100
                # ,lty=2,col="grey")+
                geom_line()+
                theme_cowplot()+
                scale_y_continuous("Percent (%)")+
                scale_x_continuous("Proportion\nRecently Vaccinated (%)", limits=c(-10,125),
                                   breaks=c(0,50,100)
                                   )+
                theme(panel.grid.minor = element_blank(),
                      panel.grid.major = element_blank(),
                      legend.position = "none"
                      )+
                scale_color_brewer(palette="Accent")+
        annotate("text",x=105,y=95,label=" Positive\nPredictive Value",
                 col=RColorBrewer::brewer.pal(3,"Accent")[2])+
        annotate("text",x=105,y=10,label=" Negative\nPredictive Value",                
                 col=RColorBrewer::brewer.pal(3,"Accent")[1])
```



```{r}
# Figure 4: External validation

external_df <- read_rds("data/generated_data/external_df.rds")


external_df %>%
        filter(training_set == "Vax included" | variables=="Reduced IgG Panel") %>%
        mutate(variables=ifelse(training_set=="No vax included",
                                "Original",variables
                                )) %>%
        group_by(variables,day,cohort)%>%
        summarize(seropos=mean(spec95_seropos)) %>%
        mutate(variables=factor(variables,
                                levels=c("All Variables",
                                         "Reduced IgG Panel",
                                         "Original"
                                         ))) %>%
        mutate(variables=fct_rev(variables))%>%
        ggplot(aes(x=factor(day),fill=variables,y=seropos))+
        geom_col(position=position_dodge2())+
        geom_hline(yintercept = 0.05,lty=2)+
        theme_cowplot()+
        xlab("Day")+
        ylab("Seropositivity"               )+
        scale_fill_brewer("Model",palette="Dark2",direction = -1)+
        theme(axis.text.x = element_text(hjust=1,angle=45))

```




```{r}


formula_all <- make_formula("vaxinf_class",all_var)
fit_all <- runCaretLOOCV(formula_all, dat=bangladeshi_fitdata)
write_rds(fit_all, paste0(path,"fit_all.rds"))

# importance_all <- caret::varImp(fit_all,scale=FALSE)


formula_three <- make_formula("vaxinf_class",three_var)
fit_three <- runCaretLOOCV(formula_three, dat=bangladeshi_fitdata)
write_rds(fit_three,paste0(path,"fit_three.rds"))

# importance_three <- caret::varImp(fit_three,scale=FALSE)

```






```{r eval=FALSE}
options(mc.cores = 1)


tvfpr_fit <- list()
tvfpr_df <- data.frame()

raw_df_list <- list(
        
        `Bangladeshi <10 years` = filter(raw_df, cohort=="BGD Vaccinee") %>%
                                        filter(age<10),
        `Bangladeshi 10+ years`= filter(raw_df, cohort=="BGD Vaccinee") %>%
                                        filter(age>=10),
        `Haitian 18+ years` = filter(raw_df, cohort=="HTI Vaccinee") ,
        
        `All Vaccinees` = raw_df

)

for(t in c(45,120,200,300)){
        for(dat in names(raw_df_list)){
                
        

                        
                        cat("Window: ",t, " Population: ",dat,"\n")  
                        
                        # estimate time-varying sensitivity
                        tvfpr_tmp <- fit_tvfpr(data = raw_df_list[[dat]] %>%
                                                       filter(end_window==t),
                                                  end_window=t,
                                                  seropos_type= "spec95_seropos",
                                                  last_time = 365,
                                                  curve="cubic"
                        )
                        
                        tvfpr_fit[[as.character(t)]][[dat]] <- tvfpr_tmp
                        
                        tmp_df<- tvfpr_tmp$summary_df 
                        
                        if(!is.null(tmp_df)){
                                tmp_df<- tmp_df %>%
                                        mutate(variables="Reduced IgG Panel")%>%
                                        mutate(seropos_type="spec95_seropos") %>%
                                        mutate(end_window=t) %>%
                                        mutate(population=dat)

                        }
                        
                        
                        tvfpr_df <-bind_rows(tvfpr_df,tmp_df)
                        
                        
                }}





write_rds(tvfpr_fit,
          paste0(path,"tvfpr_fit.rds")
)
write_rds(tvfpr_df,
          paste0(path,"tvfpr_df.rds")
)

```


```{r eval=FALSE}

path <- "source/final_code/vax_strategy/generated_rds/fpr-estimates/"


raw_df <- read_rds(
          paste0(path,"raw_df.rds")
)


tvfpr_df <- read_rds(
          paste0(path,"tvfpr_df.rds")
)


bgd_fpr<- raw_df %>% 
        filter((str_detect(cohort,"BGD"))) %>%
        mutate(age_group=ifelse(age<10,"Bangladeshi <10 years","Bangladeshi 10+ years")) %>%
        group_by(age_group,end_window,day) %>%
        summarize(seropos=mean(spec95_seropos)) %>%
        ggplot(aes(fill=factor(day),col=factor(day),
                   y=seropos,x=factor(as.numeric(end_window))))+
        geom_col(position = position_dodge2(0.1))+
        scale_fill_viridis_d("Days since first dose")+
        scale_color_viridis_d("Days since first dose")+
        facet_wrap(age_group~.)+
        theme_cowplot()+
        xlab("Infection Window (Days)")+
        scale_y_continuous("False Positivity Rate",limits=c(0,0.4))+
        geom_hline(yintercept = 0.05,lty=2)

cont_fpr <- tvfpr_df %>% 
        filter(!(str_detect(population,"Bangladesh"))) %>%
        ggplot(aes(x=time,y=median,col=factor(end_window),
                   fill=factor(end_window)
                   ))+
        geom_line()+
        geom_ribbon(aes(ymin=lb,ymax=ub),col=NA,
                                    alpha=0.5,
                        ) +
        facet_wrap(.~fct_rev(population))+
        xlab("Days since first dose")+
        scale_y_continuous("False Positivity Rate",limits=c(0,0.4))+
        scale_fill_brewer("Infection Window (Days)",palette = "Dark2")+
        scale_color_brewer("Infection Window (Days)",palette = "Dark2")+
        theme_cowplot()+
        geom_hline(yintercept = 0.05,lty=2)

plot_grid(bgd_fpr+theme(legend.position = "bottom"),
          cont_fpr+theme(legend.position = "bottom"),
          labels=c("A","B"),nrow=2)


```

\pagebreak

 

```{r compare, eval=FALSE,fig.height = 8, fig.width = 8}

# ### Figure 3: Comparison of serological measurements among recently infected and recently vaccinated individuals. 
# Boxplots show the distributions for each antibody measurement (A). Only a subset of Bangladeshi vaccinees had measurements for anti-O139 OSP IgA and IgM. The two dimensions of the separate multidimensional scaling analyses are shown in the scatterplot for each denoted time window (B).


compare_data <- final_df %>%
        filter(status %in% c("Vaccinee","Case") ) %>%
        filter(study_code!="R1") %>%
        # filter(cohort %in% c("BGD Vaccinee","SMIC/PIC")) %>%
        #limit vaccinees to only baseline and "recent samples"
        # filter(!(status=="Vaccinee" & !(day>3  & day <45))) %>%
        mutate(vaxinf_class =case_when(
                status=="Case" & day > 3 & day<200 ~ "Recently Infected",
                status=="Vaccinee" & day> 3 & day<200 ~ "Recently Vaccinated",
                TRUE ~ "Neither"
        )) %>%
        left_join(antigen_df)  %>%
        filter(vaxinf_class!="Neither")


compare_data_wide<- compare_data %>%
        select(sample,id,vaxinf_class,isotype,antigen_pretty,marker,RAU_value,day,age,status) %>% 
                        select(-isotype,-antigen_pretty) %>%
                        # mutate(RAU_value=log10(1/RAU_value)) %>%
                        spread(marker,RAU_value) %>%
                        mutate(vaxinf_class=str_remove_all(vaxinf_class," |,")) %>%
                        mutate(vaxinf_class=factor(vaxinf_class))


boxplot <- compare_data %>% 
                filter(antigen_pretty %in% c("Ogawa OSP","CT-B","TcpA","Inaba OSP","O139 OSP"))%>%
                mutate(antigen_pretty=factor(antigen_pretty,
                                             levels=c("Ogawa OSP","Inaba OSP",
                                                      "O139 OSP", "CT-B", "TcpA")
                )) %>%
                mutate(isotype=factor(isotype,levels=c("IgG","IgA","IgM"))) %>%
                mutate(vaxinf_class=case_when(
                        vaxinf_class=="Recently Infected" ~ "Infected <200 days ago",
                        vaxinf_class=="Recently Vaccinated" ~ "Vaccinated <200 days ago"
                )) %>%
                ggplot(aes(x=antigen_pretty,y=RAU_value,col=vaxinf_class))+
                geom_boxplot()+
                facet_wrap(.~isotype,nrow=1)+
                theme_cowplot()+
                theme(#axis.text.x = element_text(angle=45,hjust=1),
                        legend.position="bottom"
                )+
                xlab("Antigen")+
                scale_color_manual("Class", values=c("red","darkblue"))+
                ylab("log10(1/RAU)")+
                theme(axis.text.x = element_text(angle=45,
                                                 hjust=1
                ))



mds_plot <- bind_rows(
        compare_data_wide %>% filter(day<=45) %>%
                generate_MDS() %>% mutate(time_window="<=45 days"),
        compare_data_wide %>% filter(day>45 & day<=120)%>%
                generate_MDS() %>% mutate(time_window="46-120 days"),
        compare_data_wide %>% filter(day>120 & day<=200)%>%
                generate_MDS() %>% mutate(time_window="121-200 days")
)%>%
        mutate(time_window=factor(time_window,
                                  levels=c("<=45 days",
                                           "46-120 days",
                                           "121-200 days"
                                           )
        )) %>%

        mutate(vaxinf_class=recode(vaxinf_class,
                                   "RecentlyInfected" ="Recently Infected",
                                   "RecentlyVaccinated"="Recently Vaccinated"
        )) %>%
                ggplot(aes(x=D1,y=D2,col=vaxinf_class)) +
                geom_point(alpha=0.5,shape=16)+
                scale_color_manual("Class", values=c("red","darkblue"))+
                xlab("Dimension 1")+
                ylab("Dimension 2")+
        facet_wrap(.~time_window,scales="free")+
        theme_cowplot()


plot_grid(boxplot,
          mds_plot+theme(legend.position="none"),
          nrow=2,
          labels=c("A","B"))

```

```{r}
compare_data <- final_df %>%
        filter(status %in% c("Vaccinee","Case") ) %>%
        filter(study_code!="R1") %>%
        # filter(cohort %in% c("BGD Vaccinee","SMIC/PIC")) %>%
        #limit vaccinees to only baseline and "recent samples"
        # filter(!(status=="Vaccinee" & !(day>3  & day <45))) %>%
        mutate(vaxinf_class =case_when(
                status=="Case" & day > 3 & day<200 ~ "Recently Infected",
                status=="Vaccinee" & day> 3 & day<200 ~ "Recently Vaccinated",
                TRUE ~ "Neither"
        )) %>%
        left_join(antigen_df)  %>%
        filter(vaxinf_class!="Neither")


compare_data_wide<- compare_data %>%
        select(sample,id,vaxinf_class,isotype,antigen_pretty,marker,RAU_value,day,age,status) %>% 
                        select(-isotype,-antigen_pretty) %>%
                        # mutate(RAU_value=log10(1/RAU_value)) %>%
                        spread(marker,RAU_value) %>%
                        mutate(vaxinf_class=str_remove_all(vaxinf_class," |,")) %>%
                        mutate(vaxinf_class=factor(vaxinf_class))


boxplot <- compare_data %>% 
                filter(antigen_pretty %in% c("Ogawa OSP","CT-B","TcpA","Inaba OSP","O139 OSP"))%>%
                mutate(antigen_pretty=factor(antigen_pretty,
                                             levels=c("Ogawa OSP","Inaba OSP",
                                                      "O139 OSP", "CT-B", "TcpA")
                )) %>%
                mutate(isotype=factor(isotype,levels=c("IgG","IgA","IgM"))) %>%
                mutate(vaxinf_class=case_when(
                        vaxinf_class=="Recently Infected" ~ "Infected <200 days ago",
                        vaxinf_class=="Recently Vaccinated" ~ "Vaccinated <200 days ago"
                )) %>%
                ggplot(aes(x=antigen_pretty,y=RAU_value,col=vaxinf_class))+
                geom_boxplot()+
                facet_wrap(.~isotype,nrow=1)+
                theme_cowplot()+
                theme(#axis.text.x = element_text(angle=45,hjust=1),
                        legend.position="bottom"
                )+
                xlab("Antigen")+
                scale_color_manual("Class", values=c("red","darkblue"))+
                ylab("log10(1/RAU)")+
                theme(axis.text.x = element_text(angle=45,
                                                 hjust=1
                ))



mds_plot <- bind_rows(
        compare_data_wide %>% filter(day<=45) %>%
                generate_MDS(regex_string="Ogawa|Inaba|TcpA|IgG_O139") %>% mutate(time_window="<=45 days"),
        compare_data_wide %>% filter(day>45 & day<=120)%>%
                generate_MDS(regex_string="Ogawa|Inaba|TcpA|IgG_O139") %>% mutate(time_window="46-120 days"),
        compare_data_wide %>% filter(day>120 & day<=200)%>%
                generate_MDS(regex_string="Ogawa|Inaba|TcpA|CtxB|IgG_O139") %>% mutate(time_window="121-200 days")
)%>%
        mutate(time_window=factor(time_window,
                                  levels=c("<=45 days",
                                           "46-120 days",
                                           "121-200 days"
                                           )
        )) %>%

        mutate(vaxinf_class=recode(vaxinf_class,
                                   "RecentlyInfected" ="Recently Infected",
                                   "RecentlyVaccinated"="Recently Vaccinated"
        )) %>%
                ggplot(aes(x=D1,y=D2,col=vaxinf_class)) +
                geom_point(alpha=0.5,shape=16)+
                scale_color_manual("Class", values=c("red","darkblue"))+
                xlab("Dimension 1")+
                ylab("Dimension 2")+
        facet_wrap(.~time_window,scales="free")+
        theme_cowplot()


plot_grid(boxplot,
          mds_plot+theme(legend.position="none"),
          nrow=2,
          labels=c("A","B"))


```


\pagebreak



```{r}
### Figure 4 : Three class model
### markers
three_var <- data.frame(marker=colnames(final_wide)) %>%
                filter(str_detect(marker,"CtxB|Ogawa|Inaba")) %>%
                filter(str_detect(marker,"IgG")) %>% 
                unlist() %>% unname()

all_var <- data.frame(marker=colnames(final_wide)) %>%
                filter(str_detect(marker,"CtxB|Ogawa|Inaba|TcpA|IgG_O139")) %>%
                unlist() %>% c("age") %>% unname()


final_wide_nomissing <- final_wide[rowSums(is.na(final_wide[all_var]))==0,]


bangladeshi_fitdata <- final_wide_nomissing %>%
                filter(cohort %in% c("SMIC/PIC","BGD Vaccinee")) %>%
                mutate(vaxinf_class =case_when(
                        status=="Case" & day > 3 & day<200 ~ "RecentlyInfected",
                        status=="Vaccinee" & day> 3 & day<200 ~ "RecentlyVaccinated",
                        TRUE ~ "Neither"
                ))  %>%
         mutate(vaxinf_class2 =case_when(
                        status=="Case" & day > 3 & day<200 ~ "RecentlyInfected",
                        TRUE ~ "Neither"
                ))  %>%
        mutate(rowIndex=1:nrow(.))


```



```{r loocv}

path <- "source/final_code/vax_strategy/generated_rds/vax-classification/loocv/"


formula_all <- make_formula("vaxinf_class",all_var)
fit_all <- runCaretLOOCV(formula_all, dat=bangladeshi_fitdata)
write_rds(fit_all, paste0(path,"fit_all.rds"))

# importance_all <- caret::varImp(fit_all,scale=FALSE)


formula_three <- make_formula("vaxinf_class",three_var)
fit_three <- runCaretLOOCV(formula_three, dat=bangladeshi_fitdata)
write_rds(fit_three,paste0(path,"fit_three.rds"))

# importance_three <- caret::varImp(fit_three,scale=FALSE)

```


```{r}

path <- "source/final_code/vax_strategy/generated_rds/vax-classification/loocv/"

fit_all <- read_rds(paste0(path,"fit_all.rds"))
fit_three <- read_rds(paste0(path,"fit_three.rds"))



fit_all$pred %>% select(obs,Neither,RecentlyInfected,RecentlyVaccinated,rowIndex) %>%
        gather(pred,proportion,-c(obs,rowIndex)) %>%
        left_join(bangladeshi_fitdata) %>%
        ggplot(aes(y=reorder(sample,day),x=proportion,fill=pred))+
        geom_col()+
        facet_wrap(obs~paste(cohort,status),scales = "free")+
        theme_cowplot()+
        scale_fill_brewer("Predicted Class",palette="Dark2")+
        xlab("Proportion of Trees")+
        ylab("Sample ID")

coverage <- 0.5

fit_all$pred %>% 
        group_by(pred,obs) %>%
        count() %>%
        group_by(obs)%>%
        mutate(prop=n/sum(n)) %>%
        arrange(obs) %>%
        filter(obs!="RecentlyInfected") %>%
        ungroup() %>%
        mutate(multi=coverage*prop) %>%
        group_by(pred) %>%
        summarize(prop=sum(multi))


fit_all$pred %>% select(obs,Neither,RecentlyInfected,RecentlyVaccinated,rowIndex,pred) %>%
        gather(class,proportion,-c(obs,rowIndex,pred)) %>%
        left_join(bangladeshi_fitdata) %>%
        ggplot(aes(x=day,y=proportion))+
        geom_line(aes(group=id),alpha=0.3)+
        geom_point(aes(col=obs))+
        facet_grid(class~paste(cohort,status),scales = "free")+
        theme_cowplot()+
        scale_color_brewer("Observed", palette="Dark2")+
        ylab("Proportion of Trees")



fit_all$pred %>% select(obs,Neither,RecentlyInfected,RecentlyVaccinated,rowIndex,pred) %>%
        gather(class,proportion,-c(obs,rowIndex,pred)) %>%
        left_join(bangladeshi_fitdata) %>%
        ggplot(aes(col=class,y=proportion,x=obs))+
        geom_boxplot()+
        facet_grid(.~paste(cohort,status),scales = "free",space = "free")+
        theme_cowplot()+
        scale_color_brewer("Predicted", palette="Dark2")+
        ylab("Proportion of Trees")+
        xlab("Observed")+
        coord_flip()

        


```


```{r external-validation}

formula_all <- make_formula("vaxinf_class",all_var)
formula_three <- make_formula("vaxinf_class",three_var)
formula_all2 <- make_formula("vaxinf_class2",all_var)
formula_three2 <- make_formula("vaxinf_class2",three_var)

ranger_all <- ranger::ranger(formula_all, bangladeshi_fitdata %>%
                                     mutate(vaxinf_class=factor(vaxinf_class))
                                     )
ranger_three <- ranger::ranger(formula_three, bangladeshi_fitdata %>%
                                     mutate(vaxinf_class=factor(vaxinf_class))
                                     )
ranger_all2 <- ranger::ranger(formula_all2, bangladeshi_fitdata %>%
                                     mutate(vaxinf_class2=factor(vaxinf_class2))
                                     )
ranger_three2 <- ranger::ranger(formula_three2, bangladeshi_fitdata %>%
                                     mutate(vaxinf_class2=factor(vaxinf_class2))
                                     )

test_data <-final_wide_nomissing %>%
                filter(cohort %in% c("HTI Vaccinee","ETEC Challenge")) %>%
                mutate(`Full Set 3-class`=predict(ranger_all,data=.)$predictions,
                       `Three Markers 3-class`=predict(ranger_three,.)$predictions,
                       `Full Set 2-class`=predict(ranger_all2,.)$predictions,
                       `Three Markers 2-class`=predict(ranger_three2,.)$predictions
                       ) 

test_data %>%
        select(cohort,day, `Full Set 3-class`, `Three Markers 3-class`, `Full Set 2-class`, `Three Markers 2-class`) %>%
        gather(model,prediction,-c(cohort,day)) %>%
        group_by(model,day) %>%
        summarize(FPR=mean(prediction=="RecentlyInfected")) %>%
        ggplot(aes(x=factor(day),y=FPR))+ geom_col(position = position_dodge2())+
        facet_wrap(.~model,nrow=1)+
        theme_cowplot()+
        theme(axis.text.x = element_text(angle=45,hjust=1))
```

```{r}

path <- "source/final_code/vax_strategy/generated_rds/vax-classification/loocv/"

fit_all <- read_rds(paste0(path,"fit_all.rds"))
fit_three <- read_rds(paste0(path,"fit_three.rds"))


prop_df <- bind_rows(
                bangladeshi_fitdata %>% 
                        mutate(rowIndex=1:n()) %>%
                        left_join(fit_all$pred) %>%
                        mutate(markers="Full Set"),
                bangladeshi_fitdata %>% 
                        mutate(rowIndex=1:n()) %>%
                        left_join(fit_three$pred) %>%
                        mutate(markers="Three Markers"),
)

roc_df <- prop_df %>%
        select(obs,RecentlyInfected,RecentlyVaccinated,markers)  %>%
        gather(Class,value,-c(obs,markers)) %>%
        mutate(truth=ifelse(obs==Class,1,0))




#show roc curves and variable importance
p4a <- roc_df %>%
        mutate(Class = str_replace(Class,"Recently","Recently ")) %>% 
        ggplot()+ 
        geom_roc(aes(m = value, d = truth,col=Class,lty=markers),labels=FALSE,n.cuts=0)+ 
        geom_abline(lty=3,col="grey50")+
        xlab("False Positivity Rate")+
        ylab("True Positivity Rate")+
        scale_color_manual("Markers",values=c("red","darkblue"))+
        theme_cowplot()+
        facet_wrap(.~Class)+
        theme(legend.position = "bottom")


# prop_df %>% filter(status=="Contact") %>%
#         group_by(markers) %>%
#         summarize(prop=mean(pred=="Neither"))

p4b <- prop_df %>% filter(status %in% c("Vaccinee","Case")) %>%
        group_by(markers,day,status) %>%
        summarize(`Recently Vaccinated`=mean(pred=="RecentlyVaccinated"),
                  `Recently Infected`=mean(pred=="RecentlyInfected")
                  ) %>%
        gather(Prediction,`Proportion Predicted`,-c(markers,day,status)) %>%
        ggplot(aes(x=day,y=`Proportion Predicted`))+
                geom_line(aes(lty=markers,col=Prediction))+
        scale_y_continuous(limits=c(0,1))+
        theme_cowplot()+
        facet_grid(.~status,scales="free_x")+
        scale_color_manual(values=c("red","darkblue"))+
        xlab("Days since exposure")+
        theme(legend.position = "none")
 


test_data <-final_wide_nomissing %>%
                filter(cohort %in% c("HTI Vaccinee","ETEC Challenge")) %>%
                mutate(`Full Set`=predict(fit_all,.),
                       `Three Markers`=predict(fit_three,.)
                       ) 


p4c <- test_data %>% filter(cohort=="HTI Vaccinee") %>%
        select(day,`Full Set`,`Three Markers`) %>%
        gather(Markers,prediction,-day) %>%
        group_by(day,Markers) %>%
        summarize(`Recently Vaccinated`=mean(prediction=="RecentlyVaccinated"),
                  `Recently Infected`=mean(prediction=="RecentlyInfected"),
                  ) %>%
        gather(category,proportion,-c(day,Markers)) %>%
        ggplot(aes(x=day,y=proportion))+
        geom_line(aes(col=category,lty=Markers))+
        theme_cowplot()+
        scale_y_continuous("Proportion Predicted",limits=c(0,1))+
        xlab("Days since vaccination")+
        scale_color_manual(values=c("red","darkblue"))+
        theme(legend.position = "none")




plot_grid(p4a,p4b, p4c,ncol=1,
          labels=c("A","B","C")
          )

# prop_df %>% filter(status=="Case") %>%
#         group_by(markers,day) %>%
#         summarize(prop=mean(pred=="RecentlyInfected")) %>%
#         ggplot(aes(x=day,y=prop))+
#                 geom_line(aes(lty=markers),col="red")+
#         scale_y_continuous(limits=c(0,1))+
#         scale_x_continuous(trans="sqrt")+
#         theme_bw()
        
        




```

```{r}

#confusion matrix

prop_df %>%
                group_by(pred,obs,markers) %>%
                count() %>%
                group_by(obs,markers) %>%
                mutate(prop=n/sum(n))%>%
                mutate(Predicted = str_replace(pred,"Recently","Recently\n")) %>%
                mutate(Observed = str_replace(obs,"Recently","Recently\n")) %>%
                ggplot(aes(x=Observed,y=Predicted))+
                        geom_tile(aes(fill=prop*100))+
                        # scale_fill_viridis_c("%",limits=c(0,100),direction = -1)+
                        scale_fill_distiller("%",
                                             palette = "Oranges",
                                             limits=c(0,100),direction = 1)+
                        geom_text(aes(label=scales::percent(prop,1)))+
                theme_cowplot()+
                theme(axis.text.x = element_text(angle=45,hjust=1))+
                facet_wrap(.~markers)



```

```{r}


test_data <-final_wide_nomissing %>%
                filter(cohort %in% c("HTI Vaccinee","ETEC Challenge")) %>%
                mutate(`Full Set`=predict(fit_all,.),
                       `Three Markers`=predict(fit_three,.)
                       ) 


test_data %>% filter(cohort=="HTI Vaccinee") %>%
        select(day,`Full Set`,`Three Markers`) %>%
        gather(Markers,prediction,-day) %>%
        group_by(day,Markers) %>%
        summarize(`Recently Vaccinated`=mean(prediction=="RecentlyVaccinated"),
                  `Recently Infected`=mean(prediction=="RecentlyInfected"),
                  `Neither`=mean(prediction=="Neither")
                  ) %>%
        gather(category,proportion,-c(day,Markers)) %>%
        mutate(category=factor(category,levels=c("Neither",
                                                 "Recently Vaccinated",
                                                 "Recently Infected"
                                                 ))) %>%
        ggplot(aes(x=factor(day),y=proportion))+
        geom_col(aes(fill=Markers),position=position_dodge())+
        facet_wrap(.~category)

test_data %>% filter(cohort=="HTI Vaccinee") %>%
        select(day,`Full Set`,`Three Markers`) %>%
        gather(Markers,prediction,-day) %>%
        group_by(day,Markers) %>%
        summarize(`Recently Vaccinated`=mean(prediction=="RecentlyVaccinated"),
                  `Recently Infected`=mean(prediction=="RecentlyInfected"),
                  `Neither`=mean(prediction=="Neither")
                  ) %>%
        gather(category,proportion,-c(day,Markers)) %>%
        mutate(category=factor(category,levels=c("Neither",
                                                 "Recently Vaccinated",
                                                 "Recently Infected"
                                                 ))) %>%
        ggplot(aes(x=factor(day),y=proportion))+
        geom_col(aes(fill=category))+
        facet_wrap(.~Markers)






```




```{r}
## Two class model
bangladeshi_twofitdata <- final_wide_nomissing %>%
                filter(cohort %in% c("SMIC/PIC","BGD Vaccinee")) %>%
                mutate(vaxinf_class =case_when(
                        status=="Case" & day > 3 & day<200 ~ "RecentlyInfected",
                        TRUE ~ "NotRecentlyInfected"
                )) 

two_formula_all <- make_formula("vaxinf_class",all_var)
two_fit_all <- runCaretLOOCV(formula_all, dat=bangladeshi_twofitdata)
two_importance_all <- caret::varImp(two_fit_all,scale=FALSE)


two_formula_three <- make_formula("vaxinf_class",three_var)
two_fit_three <- runCaretLOOCV(formula_three, dat=bangladeshi_twofitdata)
two_importance_three <- caret::varImp(two_fit_three,scale=FALSE)




two_prop_df <- bind_rows(
                bangladeshi_fitdata %>% 
                        mutate(rowIndex=1:n()) %>%
                        left_join(two_fit_all$pred) %>%
                        mutate(markers="Full Set"),
                bangladeshi_fitdata %>% 
                        mutate(rowIndex=1:n()) %>%
                        left_join(two_fit_three$pred) %>%
                        mutate(markers="Three Markers"),
)
        


two_roc_df <- two_prop_df %>%
        select(obs,RecentlyInfected,markers)  %>%
        gather(Class,value,-c(obs,markers)) %>%
        mutate(truth=ifelse(obs==Class,1,0))


two_roc_df %>%
        mutate(Class = str_replace(Class,"Recently","Recently ")) %>%
        ggplot()+ 
        geom_roc(aes(m = value, d = truth,col=Class,lty=markers),labels=FALSE,n.cuts=0)+ 
        geom_abline(lty=3,col="grey50")+
        xlab("False Positivity Rate")+
        ylab("True Positivity Rate")+
        scale_color_manual(values=c("red","darkblue"))+
        theme_cowplot()#+


        

two_prop_df %>%
                group_by(pred,obs,markers) %>%
                count() %>%
                group_by(obs,markers) %>%
                mutate(prop=n/sum(n))%>%
                mutate(Predicted = str_replace(pred,"Recently","Recently\n")) %>%
                mutate(Observed = str_replace(obs,"Recently","Recently\n")) %>%
                ggplot(aes(x=Observed,y=Predicted))+
                        geom_tile(aes(fill=prop*100))+
                        # scale_fill_viridis_c("%",limits=c(0,100),direction = -1)+
                        scale_fill_distiller("%",
                                             palette = "Oranges",
                                             limits=c(0,100),direction = 1)+
                        geom_text(aes(label=scales::percent(prop,1)))+
                theme_cowplot()+
                theme(axis.text.x = element_text(angle=45,hjust=1))+
                facet_wrap(.~markers)




two_test_data <-final_wide_nomissing %>%
                filter(cohort %in% c("HTI Vaccinee"))%>%
                mutate(`Full Set`=predict(two_fit_all,.),
                       `Three Markers`=predict(two_fit_three,.)
                       )         

two_test_data %>% 
        select(day,`Full Set`,`Three Markers`) %>%
        gather(Markers,prediction,-day) %>%
        group_by(day,Markers) %>%
        summarize(
                  `Recently Infected`=mean(prediction=="RecentlyInfected"),
                  `Not Recently Infected`=mean(prediction=="NotRecentlyInfected")
                  ) %>%
        gather(category,proportion,-c(day,Markers)) %>%
        ggplot(aes(x=factor(day),y=proportion))+
        geom_col(aes(fill=Markers),position=position_dodge2())+
        facet_wrap(.~category)




```


```{r etec}


final_df %>% filter(cohort %in% c("ETEC Challenge","SMIC/PIC")) %>%
        filter(day<50) %>%
        filter(status=="Case" | is.na(status))%>%
        filter(antigen_pretty %in% c("CT-B","Ogawa OSP")) %>%
        ggplot(aes(x=factor(day),y=RAU_value,col=cohort)
               )+
        geom_line(aes(group=id),  alpha=0.5)+
        facet_grid(antigen_pretty~isotype)+
        theme_cowplot()


etec_pred <-final_wide %>%
                filter(cohort %in% c("ETEC Challenge"))%>%
                mutate(
                       `Three Markers`=predict(two_fit_three,.)
                       )       




etec_pred %>% 
        ggplot(aes(y=id,x=factor(day)))+
        geom_tile(aes(fill=`Three Markers`))


```



Current figure 4 is everything below

```{r}


multi_class_data <- final_df %>%
        filter(status %in% c("Vaccinee","Case","Contact") ) %>%
        # filter(cohort %in% c("BGD Vaccinee","SMIC/PIC")) %>%
        #limit vaccinees to only baseline and "recent samples"
        # filter(!(status=="Vaccinee" & !(day>3  & day <45))) %>%
        mutate(vaxinf_class =case_when(
                status=="Case" & day > 3 & day<200 ~ "Recently Infected",
                status=="Vaccinee" & day> 3 & day<200 ~ "Recently Vaccinated",
                TRUE ~ "Neither"
        )) %>%
        left_join(antigen_df) 


var_list <- multi_class_data %>% distinct(marker) %>%
                filter(str_detect(marker,"CtxB|Ogawa|Inaba|TcpA|IgG_O139")) %>%
                unlist() %>% c("age") %>% as.character()


caret_data <- multi_class_data %>%
        select(cohort,sample,id,vaxinf_class,isotype,antigen_pretty,marker,RAU_value,day,age,status) %>% 
        filter(marker %in% var_list) %>%
                        select(-isotype,-antigen_pretty) %>%
                        mutate(RAU_value=log10(1/RAU_value)) %>%
                        spread(marker,RAU_value) %>%
                        mutate(vaxinf_class=str_remove_all(vaxinf_class," |,")) %>%
                        mutate(vaxinf_class=factor(vaxinf_class))




formula_all <- make_formula("vaxinf_class",var_list)
fit_all <- runCaretLOOCV(formula_all, dat=caret_data_nomissing)
importance_all <- caret::varImp(fit_all,scale=FALSE)

write_rds(fit_all,"source/final_code/vax_strategy/generated_rds/fit_all.rds")
write_rds(importance_all,"source/final_code/vax_strategy/generated_rds/importance_all.rds")
```


```{r}

fit_all <- read_rds("source/final_code/vax_strategy/generated_rds/fit_all.rds")
importance_all <- read_rds("source/final_code/vax_strategy/generated_rds/importance_all.rds")



proportion_15 <- caret_data_nomissing %>% 
        mutate(rowIndex=1:n()) %>%
        left_join(fit_all$pred)

roc_df15 <- proportion_15 %>%
        select(obs,RecentlyInfected,RecentlyVaccinated)  %>%
        gather(Class,value,-obs) %>%
        mutate(truth=ifelse(obs==Class,1,0))


#show roc curves and variable importance
roc_curve <- roc_df15 %>%
        mutate(Class = str_replace(Class,"Recently","Recently ")) %>%
        ggplot()+ 
        geom_roc(aes(m = value, d = truth,col=Class),labels=FALSE,n.cuts=0)+ 
        geom_abline(lty=2,col="grey50")+
        xlab("False Positivity Rate")+
        ylab("True Positivity Rate")+
        scale_color_manual(values=c("red","darkblue"))+
        theme_cowplot()+
        theme(legend.position = "none")


importance_plot <- importance_all$importance %>%
        mutate(Antibody=rownames(.)) %>%
        # left_join(distinct(multi_class_data,marker,
        #                    isotype,antigen,antigen_pretty)) %>%
        # mutate(Antibody=glue::glue("anti-{antigen_pretty} {isotype}")) %>%
        # slice_max(Overall,n=10)%>%
        ggplot(aes(x=Overall,y=reorder(Antibody,Overall)))+
                geom_col()+
        # scale_x_continuous("Gini Index",breaks=c(0,15,30),limits = c(0,30))+
        theme_bw()+
        theme(legend.position = "none",
              panel.grid=element_blank(),
              axis.title.y = element_blank()
             )


# model_plot<- ggdraw() +
#         draw_plot(roc_curve) +
        # draw_plot(importance_plot, x = 0.45, y = 0.23, width = .5, height = .6)

# confusion matrix
confusion_plot <- proportion_15 %>%
                group_by(pred,obs) %>%
                count() %>%
                group_by(obs) %>%
                mutate(prop=n/sum(n))%>%
                mutate(Predicted = str_replace(pred,"Recently","Recently\n")) %>%
                mutate(Observed = str_replace(obs,"Recently","Recently\n")) %>%
                ggplot(aes(x=Observed,y=Predicted))+
                        geom_tile(aes(fill=prop*100))+
                        # scale_fill_viridis_c("%",limits=c(0,100),direction = -1)+
                        scale_fill_distiller("%",
                                             palette = "Oranges",
                                             limits=c(0,100),direction = 1)+
                        geom_text(aes(label=scales::percent(prop,1)))+
                theme_cowplot()+
                theme(axis.text.x = element_text(angle=45,hjust=1))



plot_grid(roc_curve,importance_plot,confusion_plot,labels=c("A","B","C"))



#Using all the data
#use a 200 day window
#unweighted model with age for now


#Conduct LOOCV
#show importance
#show the confusion matrix

#Using just the bangladeshi data

#Conduct LOOCV
#show importance
#show the confusion matrix

#apply bangladeshi model to haitian data

```


\pagebreak







