---
title: "Main figures for Cholera serosurveillance in partially vaccinated populations"
author: "Forrest Jones"
date: "`r Sys.Date()`"
output:
  html_document:
    self_contained: yes
  word_document: default 
---

```{r setup, include=FALSE}


library(knitr)

knitr::opts_chunk$set(echo = FALSE,message = FALSE,warning = FALSE,
                      cache = TRUE,
                      fig.height = 7,
                      fig.width = 10, eval=FALSE#,
                      #dev="pdf" 
                      )

```


```{r eval = FALSE}

#run these first to create the objects used in the figures
source("code/R/misclassification.R")
source("code/R/loocv_new.R") #this ones takes awhile
source("code/R/simulation.R") #this one takes awhile
source("code/R/multidimensional-scaling.R")



```


```{r load, eval = TRUE}
rm(list=ls())

source("code/R/packages.R")
source("code/R/utils.R")

# new_qc.R, clean-data.R load-data.R to see how final_df and final_wide are created

final_df <- read_rds("data/generated_data/analysis_data/final_df.rds")
final_wide <-read_rds("data/generated_data/analysis_data/final_wide.rds")

```


## Main Text 

### Results

```{r study-pop1}
final_wide %>%
        filter(cohort %in% c("BGD Vaccinee","HTI Vaccinee")) %>%
        group_by(cohort)%>%
        summarize(samples=n(),
                  individuals=length(unique(id)),
                  under10=length(unique(id[age<10])),
                  male=length(unique(id[sex=="male"]))
                  ) %>%
        mutate(under10=glue::glue("{under10} ({round(under10/individuals,2)*100})"),
               male=glue::glue("{male} ({round(male/individuals,2)*100})")
               )
        


final_wide %>%
        filter(cohort %in% c("SMIC/PIC")) %>%
        filter(status=="Case")%>%
        group_by(cohort)%>%
        summarize(samples=n(),
                  individuals=length(unique(id)),
                  under10=length(unique(id[age<10])),
                  male=length(unique(id[sex=="male"])),
                  culture=length(unique(id[culture=="O1-Ogawa"]))
                  ) %>%
        mutate(under10=glue::glue("{under10} ({round(under10/individuals,2)*100})"),
               male=glue::glue("{male} ({round(male/individuals,2)*100})"),
               culture=glue::glue("{culture} ({round(culture/individuals,2)*100})")
               )

final_wide %>%
        filter(status=="Contact") %>%
        group_by(cohort)%>%
        summarize(samples=n(),
                  individuals=length(unique(id)))


final_wide %>%
        filter(status=="Contact") %>%
        distinct(id,age, sex)

```


```{r study-pop2}

final_wide %>%
        filter(cohort=="BGD Vaccinee") %>%
        count(day)

final_wide %>%
        filter(cohort=="HTI Vaccinee") %>%
        mutate(individuals=length(unique(id))) %>%
        count(day,individuals) %>%
        mutate(percent=round(n/individuals,2)*100)


final_wide %>%
        filter(cohort %in% c("SMIC/PIC")) %>%
        filter(status=="Case")%>%
        count(id) %>% 
        summary()

final_wide %>%
        filter(cohort %in% c("SMIC/PIC")) %>%
        filter(status=="Contact")%>%
        count(day) %>% 
        summary()
```

__Table 1:Individual characteristics of culture confirmed cholera patients and vaccinated individuals__

Serological data were also available for three uninfected household contacts of Bangladeshi cases enrolled with measurements taken at 2, 7, and 30 days after enrollment of the initial case


```{r table-1, eval=TRUE}


tab1_df <- final_df %>%
        filter(status %in% c("Case","Vaccinee")) %>%
        distinct(cohort,studycode,id,age_group,sex,blood,culture,status) %>%
# get categorical variables together
        group_by(cohort) %>%
        summarize(n=n(),
                  `< 5 years`=sum(age_group=="<5 years"),
                  `5-9 years`=sum(age_group=="5-9 years"),
                  `10-17 years`=sum(age_group=="10-17 years"),
                  `18+ years`=sum(age_group=="18+ years"),
                  
                  Female = sum(sex=="female"),
                  
                  `O Blood Group` = sum(blood=="O"),
                  
                  `V. cholerae O1 Ogawa isolated` = sum(culture=="O1-Ogawa"),
        ) %>%
        gather(variable,value,-c(cohort,n)) %>% 
        # filter(!is.na(value)) %>%
        mutate(percent=round(value/n*100)) %>%
        mutate(final_value= ifelse(is.na(value),"-",paste0(value," (",percent,")"))) %>%
        mutate(row_name=paste(variable,"(%)")) %>%
        select(cohort,n,row_name,final_value)


t1 <- tab1_df %>%
        mutate(row_name=factor(row_name,
                               levels = c("< 5 years (%)",                     "5-9 years (%)"  ,                  
                                          "10-17 years (%)"   ,                "18+ years (%)"     ,               
                                          "Female (%)"  ,                      "O Blood Group (%)" ,               
                                          "V. cholerae O1 Ogawa isolated (%)")
        )) %>%
        mutate(column_header= case_when(
                cohort == "SMIC/PIC" ~ "Bangladeshi cholera cases",
                cohort == "BGD Vaccinee" ~ "Bangladeshi vaccinees",
                cohort == "HTI Vaccinee" ~ "Haitian vaccinees"
                
        )) %>%
        mutate(column_header=paste0(column_header,"\n(n=",n,")")) %>%
        select(column_header,row_name,final_value) %>%
        spread(column_header,final_value) %>%
        bind_rows(data.frame(row_name="Age Group"),.) %>%
        rename(Characteristics=row_name) %>%
        flextable::flextable() %>%
        flextable::autofit() %>%
        flextable::padding(i=2:5, j=1, padding.left=20) %>%
        flextable::align(align = "center",j=2:4,part="all") %>%
        flextable::width(width = 1.5) 


t1

t1 %>% flextable::save_as_docx( path = "figures/tables/table_1.docx")



```


\pagebreak

#### Immune response to vaccination and infection differ in magnitude and breadth

__Figure 1:  Multiplex bead assay measurements of IgG, IgM, and IgA against OSP, CT-B, and TcpA antigens among vaccinated volunteers__



```{r f1-spaghetti-rau,  eval=TRUE, fig.height = 7, fig.width = 10}

#data for figure 1
fig1_df <- final_df %>% 
        filter(antigen_pretty %in% c("Ogawa OSP","Inaba OSP","O139 OSP","CT-B","TcpA")) %>%
        mutate(antigen_pretty=factor(antigen_pretty,levels=c("Ogawa OSP","Inaba OSP","O139 OSP","CT-B","TcpA"))) %>%
        mutate(isotype=factor(isotype,levels=c("IgG","IgA","IgM"))) %>%
        filter(studycode!="R1") 



#case true positives
true_pos <- fig1_df %>% filter(
                   status=="Case",
                   day > 2,
                   day<200
                   )

#case true negatives
true_neg <- fig1_df %>%
                filter(cohort=="SMIC/PIC") %>%
                anti_join(true_pos)
        



f1 <- fig1_df %>%
        filter(status=="Vaccinee")  %>%
        mutate(Vaccinee=case_when(
                cohort== "BGD Vaccinee" & age <10 ~ "Bangladeshi < 10 years",
                cohort== "BGD Vaccinee" & age>=10 ~ "Bangladeshi 10+ years",
                TRUE ~ "Haitian 18+ years"
        )) %>%
        ggplot(aes(y=RAU_value))+
                geom_line(aes(group=id,
                              x=day,
                              col=Vaccinee
                              ),
                          alpha=0.5
                          )+
        # geom_point(aes(
        #                       x=day,
        #                       col=Vaccinee
        #                       ),
        #                   alpha=0.5
        #                   )+
                geom_rug(data=true_pos,sides="l",col="red",alpha=0.3)+
                geom_rug(data=true_neg,sides="r",col="black",alpha=0.3)+
                facet_grid(isotype~antigen_pretty)+
                scale_color_manual(values = c("lightblue","#003262","#FDB515")
                                   )+
                scale_x_continuous("Days since first dose",breaks=c(1,30,200,365) ,trans="sqrt")+
        geom_vline(xintercept = 14,lty=2)+
        ylab("log10(1/RAU)")+
        guides(color=guide_legend(override.aes=list(alpha=NA)))+
        theme_cowplot()+
        theme(legend.position = "bottom")
  
  
f1

ggsave(plot=f1,filename="figures/main_text/figure1.pdf", height = 4.36,width = 6.5,scale = 1.5)
ggsave(plot=f1,filename="figures/main_text/figure1.tiff", height = 4.36,width = 6.5,scale = 1.5)
ggsave(plot=f1,filename="figures/main_text/figure1.png", height = 4.36,width = 6.5,scale = 1.5)


```


\pagebreak


#### Previous seroincidence models frequently misclassify vaccination as recent infection

__Figure 2:  Misclassification of vaccinees as seropositive by previous seroincidence models using 45, 120, 200, and 300 day infection windows__

```{r misclassify-figure, eval=TRUE,fig.width=9.1,fig.height=7}



#get data for misclassification
misclassify_df <- read_rds("data/generated_data/analysis_objects/misclassification/misclassify_df.rds")
tvfpr_df <- read_rds("data/generated_data/analysis_objects/misclassification/tvfpr_df.rds")


misclassify_df%>% filter(variables=="Reduced IgG Panel")%>%
        filter(cohort %in% c("HTI Vaccinee","BGD Vaccinee"))%>%
        filter(end_window %in% c("45"))%>%
        group_by(day,end_window,cohort) %>%
        summarize(seropos=sum(spec95_seropos),
                  n=n(),
                  )%>%
        mutate(per_pos=seropos/n) %>% 
        arrange(cohort)


filter(tvfpr_df,population== "All Vaccinees (Reduced IgG Panel)") %>%
        filter(end_window %in% c(120,200,300)) %>%
        group_by(end_window) %>%
        filter(median==max(median))



filter(tvfpr_df,population== "All Vaccinees (Reduced IgG Panel)") %>%
        filter(end_window %in% c(120,200,300)) %>%
        group_by(end_window) %>%
        filter(median>=0.05) %>%
        filter(time==min(time))

filter(tvfpr_df,population== "All Vaccinees (Reduced IgG Panel)") %>%
        filter(end_window %in% c(120,200,300)) %>%
        group_by(end_window) %>%
        filter(median>=0.05) %>%
        filter(time==max(time))


# filter(tvfpr_df,population== "All Vaccinees (Reduced IgG Panel [NO AGE])") %>%
#         filter(end_window %in% c(120,200,300)) %>%
#         filter(time>14)%>%
#         group_by(end_window) %>%
#         slice_min(abs(median-0.05),n=1)


misclassify_df%>% filter(variables=="Reduced IgG Panel")%>%
        filter(cohort %in% c("ETEC Challenge"))%>%
        filter(end_window %in% c("200"))%>%
        group_by(day,end_window,cohort) %>%
        summarize(seropos=sum(spec95_seropos),
                  n=n(),
                  )%>%
        mutate(per_pos=seropos/n) 



f2a <- misclassify_df %>% filter(variables=="Reduced IgG Panel")%>%
        filter(cohort %in% c("HTI Vaccinee","BGD Vaccinee"))%>%
        group_by(day,end_window,cohort) %>%
        summarize(seropos=mean(spec95_seropos))%>%
        filter(end_window %in% c("45","120","200","300"))%>%
        mutate(end_window=factor(end_window,
                        levels=c("45","120","200","300"),
                        labels=c("45-day","120-day","200-day","300-day")))%>%
        mutate(Vaccinee=case_when(
                        cohort=="BGD Vaccinee" ~ "Bangladeshi",
                        cohort=="HTI Vaccinee" ~ "Haitian"
        )) %>%
        ggplot()+
        geom_point(aes(col=Vaccinee,
                   y=seropos,x=day,shape=Vaccinee))+
        geom_line(data=filter(tvfpr_df,population== "All Vaccinees (Reduced IgG Panel)")%>%
                        mutate(end_window=factor(end_window,
                                 levels=c("45","120","200","300"),
                                 labels=c("45-day","120-day","200-day","300-day"))),
                        aes(x=time,y=median))+
        geom_ribbon(data=filter(tvfpr_df,population== "All Vaccinees (Reduced IgG Panel)")%>%
                        mutate(end_window=factor(end_window,
                                 levels=c("45","120","200","300"),
                                 labels=c("45-day","120-day","200-day","300-day"))),
                        aes(x=time,ymin=lb,ymax=ub),col=NA,
                                    alpha=0.2,
                        )+
        facet_grid(.~end_window)+
        theme_cowplot()+
        scale_x_continuous("Days since first dose",breaks=seq(0,365,90))+
        scale_y_continuous("Proportion Seroincident")+
        scale_color_manual(values = c("#003262","#FDB515"))+
        scale_shape_manual(values=c(1,1))+
        geom_hline(yintercept = 0.05,lty=2)+
        theme(legend.position = "bottom")
        
      

nmfp_label_df <- data.frame(
                end_window="45",
                X=270,
                Y=0.15
) %>% mutate(end_window=factor(end_window,
                                 levels=c("45","120","200","300"),
                                 labels=c("45-day","120-day","200-day","300-day")))
  
f2<- f2a + geom_text(data=nmfp_label_df,
                label="Nominal false\npositive rate",
                aes(x=X,y=Y),fontface="bold"
                )+
  geom_segment(data=nmfp_label_df,
               aes(xend = X, x = X,
               yend =Y-0.095,y=Y-0.03),
    arrow = arrow(length = unit(0.2,"cm"),
                  type="closed"
                  ))

f2

ggsave(plot=f2,filename="figures/main_text/figure2.pdf", height = 2.39,width = 6.5,scale = 1.5)
ggsave(plot=f2,filename="figures/main_text/figure2.tiff", height = 2.39,width = 6.5,scale = 1.5)
ggsave(plot=f2,filename="figures/main_text/figure2.png", height = 2.39,width = 6.5,scale = 1.5)

```

#### Inclusion of data from vaccinees improved performance of seroincidence models without the need for additional antigen targets

__Figure 3: Random forest classification model performance at distinguishing samples of recently infected cases (<200 days) from samples of recently vaccinees, uninfected contacts, and cases that were not recently infected (200+ days).__


```{r newfigure3, eval=FALSE}

#load the original model objects
tvfpr_df <- read_rds("data/generated_data/analysis_objects/misclassification/tvfpr_df.rds")
tvfpr_fit <- read_rds(
          paste0("data/generated_data/analysis_objects/misclassification/","tvfpr_fit.rds")
)

tvfpr_fit_200 <- tvfpr_fit$`200`$`All Vaccinees (Reduced IgG Panel)`

#load the new model objects

loocv_tvfit_df <- read_rds(
          paste0("data/generated_data/analysis_objects/loocv/","loocv_tvfit_df_new.rds")
)

loocv_tvfit_list <- read_rds(
          paste0("data/generated_data/analysis_objects/loocv/","loocv_tvfit_list_new.rds")
)

loocv_spec_df<- read_rds(
          paste0("data/generated_data/analysis_objects/loocv/","loocv_spec_df_new.rds")
)

loocv_df <- read_rds("data/generated_data/analysis_objects/loocv/loocv_df_new.rds")


p1 <- loocv_tvfit_df %>%
        filter(time<=200)%>%
        filter(population=="Vaccinee")%>%
        filter(str_detect(variables,"reduced"))%>%
        ggplot(aes(col=variables,fill=variables))+
                geom_line(aes(x=time,y=median))+
                geom_ribbon(aes(x=time,ymin=lb,ymax=ub),alpha=0.5,col=NA)+
                geom_line(data=tvfpr_df %>%
                                  filter(end_window==200)%>%
                                  filter(time<=200)%>%
                                  filter(population=="All Vaccinees (Reduced IgG Panel)"),
                          col="black",aes(x=time,y=median),lwd=1,
                          inherit.aes = FALSE
                          )+
        scale_color_manual(values = c("red","blue"))+
        scale_fill_manual(values = c("red","blue"))+
        xlab("Days since vaccination")+
        scale_y_continuous("False Positive Rate",limits = c(0,0.25))+
        geom_hline(yintercept = 0.05,lty=2)+
        theme_cowplot()+
        theme(legend.position = "none")


p2_vax_df <- bind_rows(
        
        tvfpr_fit_200$out_df %>%
        filter(time<=200) %>% group_by(.draw)%>%
        summarize(avg=mean(theta)) %>%
        ungroup()%>%
        summarize(median=median(avg),
                  lb=quantile(avg,0.025),
                  ub=quantile(avg,0.975)
                  )%>%
        mutate(variables="original"),


        loocv_tvfit_list$reduced_2class$all_fitdata$`200-day`$Vaccinee$out_df %>%
        filter(time<=200) %>% group_by(.draw)%>%
        summarize(avg=mean(theta)) %>%
        ungroup()%>%
        summarize(median=median(avg),
                  lb=quantile(avg,0.025),
                  ub=quantile(avg,0.975)
                  )%>%
        mutate(variables="reduced_2class"),


        loocv_tvfit_list$reduced_3class$all_fitdata$`200-day`$Vaccinee$out_df %>%
        filter(time<=200)%>% group_by(.draw)%>%
        summarize(avg=mean(theta)) %>%
        ungroup()%>%
        summarize(median=median(avg),
                  lb=quantile(avg,0.025),
                  ub=quantile(avg,0.975)
                  ) %>%
                mutate(variables="reduced_3class")
) %>% mutate(population="Vaccinated")  

p2_outside_df <- loocv_spec_df %>% 
                        filter(str_detect(variables,"reduced")) %>%
                        filter(population=="Outside Window") %>%
                        mutate(variables=ifelse(base_data_name=="case_fitdata",
                                                "original",variables
                                                )) %>%
                        mutate(median=1-median,
                               lb_new=1-ub,
                               ub=1-lb
                               )%>%
                        select(median,lb=lb_new,ub,variables,population)%>%
                        mutate(population="Unvaccinated")



bind_rows(p2_outside_df,p2_vax_df)%>%
        mutate(Model=factor(variables,
                            levels=c("original","reduced_2class","reduced_3class"),
                            labels=c("Infection-Only model",
                                     "Mixed-Cohort\nTwo Class model",
                                     "Mixed-Cohort\nThree Class model"
                                     )
                            ))



p2<- bind_rows(p2_outside_df,p2_vax_df)%>%
        mutate(Model=factor(variables,
                            levels=c("original","reduced_2class","reduced_3class"),
                            labels=c("Infection-Only model",
                                     "Mixed-Cohort\nTwo Class model",
                                     "Mixed-Cohort\nThree Class model"
                                     )
                            )) %>%
        mutate(population=factor(population))%>%
        mutate(population=fct_rev(population))%>%
        ggplot()+
                geom_point(aes(x=population,y=median,col=Model),
                           position = position_dodge(0.5)
                           )+
                geom_linerange(aes(x=population,ymin=lb,ymax=ub,col=Model),
                           position = position_dodge(0.5)
                           )+
        theme_cowplot()+
        geom_hline(yintercept = 0.05,lty=2)+
        scale_color_manual(values = c("black","red","blue"))+
        scale_y_continuous("False Positive Rate",limits = c(0,0.25))+
        xlab("Population")

p3_df <- loocv_tvfit_df %>%
        filter(population=="Case")%>%
        filter(str_detect(variables,"reduced"))%>%
                        mutate(variables=ifelse(base_data_name=="case_fitdata",
                                                "original",variables
                                                )) %>%
        filter(time<=200)

p3_df %>% group_by(variables,base_data_name) %>%
        summarize(mean(median),
                  time[median==max(median)]
                  )







p3 <- p3_df%>%
        filter(str_detect(variables,"reduced"))%>%
        ggplot(aes(col=variables,fill=variables))+
                geom_line(aes(x=time,y=median))+
                geom_ribbon(aes(x=time,ymin=lb,ymax=ub),alpha=0.5,col=NA)+
        geom_line(data=p3_df %>%
                          filter(variables=="original"),
                  col="black",aes(x=time,y=median), lwd=1,
                  inherit.aes = FALSE
                  )+
        scale_color_manual(values = c("red","blue"))+
        scale_fill_manual(values = c("red","blue"))+
        xlab("Days since infection")+
        scale_y_continuous("Sensitivity",limits=c(0,1))+
        theme_cowplot()+
        theme(legend.position = "none")



p4_df <- loocv_df %>%
        filter(variables=="reduced_3class") %>%
        mutate(across(Neither:RecentlyVaccinated,.fns = ~ifelse(is.na(.x),
                                                                0,.x
                                                                ))) %>%
        mutate(prediction=case_when(
                Neither >= RecentlyInfected & Neither >=RecentlyVaccinated ~"Neither",
                RecentlyInfected > Neither & RecentlyInfected >= RecentlyVaccinated ~"RecentlyInfected",
                RecentlyVaccinated > Neither & RecentlyVaccinated > RecentlyInfected ~"RecentlyVaccinated"
        )) %>%
        mutate(three_class=factor(three_class),
                  prediction=factor(prediction)
        ) %>%
        count(variables,three_class,prediction,.drop=FALSE)



p4_df %>%
        group_by(three_class)%>%
        mutate(total=sum(n)) %>%
        mutate(proporiton=n/sum(n))
        
        
        
p4 <- p4_df%>%
        group_by(variables,three_class) %>%
        mutate(proportion=n/sum(n)) %>%
        mutate(three_class=str_replace(three_class,"Recently","Recently\n"))%>%
        mutate(three_class=glue::glue("{three_class}\n(n={sum(n)})"))%>%
        mutate(prediction=str_replace(prediction,"Recently","Recently\n"))%>%
        ggplot(aes(x=three_class,y=prediction))+
        geom_tile(aes(fill=100*proportion))+
        geom_text(aes(label=paste0(100*round(proportion,2),"%")))+
        scale_fill_distiller("Percent\nClassified",palette = "Blues",
                             direction = 1,limits=c(0,100),
        )+
        xlab("True Class")+
        ylab("Predicted Class")+
        theme_cowplot()



f3 <- plot_grid(
        plot_grid(p1,p2,nrow=1,rel_widths = c(1,1.2), labels=c("A","B")),
        plot_grid(p3,p4,nrow = 1,rel_widths = c(1,1.2), labels=c("C","D")),
        nrow=2
        )

f3

ggsave(plot=f3,filename="figures/main_text/figure3.pdf", height = 4.22,width = 6.5,scale = 1.5)
ggsave(plot=f3,filename="figures/main_text/figure3.tiff", height = 4.22,width = 6.5,scale = 1.5)
ggsave(plot=f3,filename="figures/main_text/figure3.png", height = 4.22,width = 6.5,scale = 1.5)




```


#### Multiple adjustment strategies address bias in seroincidence estimates in partially-vaccinated populations 



__Figure 4. Simulated serological surveys in settings with varying levels of vaccination coverage using multiple strategies to calculate seroincidence__


```{r simulation-figure, eval=TRUE}
simulation_df <- read_rds("data/generated_data/analysis_objects/simulation/simulation_df_10.rds")
lambda_df <- read_rds("data/generated_data/analysis_objects/simulation/lambda_df_10.rds")
sims_original <- read_rds("data/generated_data/analysis_objects/simulation/sims_original_10.rds")


f4_df <- lambda_df %>%
        mutate(campaign_day=ifelse(campaign_day==21,
                                   "Early serosurvey (21 days post campaign start)",
                                   "Late serosurvey (120 days post campaign start)"
                                   ))%>%
        mutate(new_coverage=factor(coverage,
                                   labels=c("0%",
                                            "25%",
                                            "50%",
                                            "75%"
                                            )
                                   )) %>%
        mutate(new_adjustment=case_when(
                adjustment=="Alternative" ~3,
                adjustment=="Ignore" ~ 1,
                adjustment=="Questionnaire" ~ 2
        )) %>%
        mutate(new_adjustment=factor(new_adjustment,
                                     labels=c("Crude adjustment with\nthe Infection-Only Model",
                                              "Stratified adjustment with\nthe Infection-Only Model",
                                              "Coverage adjustment with\nthe Mixed-Cohort Two Class Model"
                                              )
                                     ))
        

        
f4 <- f4_df %>%
        ggplot()+
        geom_hline(yintercept=10,lty=2)+
        geom_boxplot(aes(y=lambda*100,x=new_coverage,col=new_adjustment),fill=NA)+
        scale_color_brewer("Adjustment Method",palette = "Dark2")+
        facet_wrap((campaign_day)~.)+
        cowplot::theme_cowplot()+
        ylab("200-day seroincidence\n(Infections per 100 population)")+
        xlab("Vaccination Coverage")+
        theme(legend.position = "bottom")

f4

ggsave(plot=f4,filename="figures/main_text/figure4.pdf", height = 2.89,width = 6.09,scale = 1.7)
ggsave(plot=f4,filename="figures/main_text/figure4.tiff", height = 2.89,width = 6.09,scale = 1.7)
ggsave(plot=f4,filename="figures/main_text/figure4.png", height = 2.89,width = 6.09,scale = 1.7)


```

```{r, simulation-bias}


lambda_df %>%
        mutate(model=ifelse(adjustment=="Alternative",
                            "Alternative","Original"
                            )) %>%
        left_join(simulation_df, by = c("coverage", "campaign_day", "simulation", "model")) %>%
        mutate(bias=(lambda-truth)/truth*100) %>%
        group_by(adjustment,coverage,campaign_day) %>%
        summarise(avg=round(mean(bias)),min=round(min(bias)),max=round(max(bias))) %>%
        filter(adjustment=="Ignore")


lambda_df %>%
        filter(coverage==0.5)%>%
        filter(campaign_day==21)%>%
        group_by(adjustment,coverage,campaign_day)%>%
        summarize(mean(lambda),min(lambda),max(lambda))

        

```


### Methods

```{r}
read_rds("data/generated_data/quality_control/complete_raw_data.rds") %>%
        filter(subclass=="total")%>%
        count(Count<30) %>%
        mutate(percent=100*n/sum(n))


read_excel("data/raw_data/cohort_data/RIK Sero2 Electronic Lab Registry_ Sample inventory.xls") %>% View()

read_excel("data/raw_data/cohort_data/RIK Sero2 Electronic Lab Registry_ Sample inventory.xls") %>% 
    select(id=`RIK ID No.`,starts_with("Date of Day"))%>%
    gather(day,date,-id) %>%
        filter(!is.na(date))%>%
        count(id) %>%
        summarise(sum(n>=3),
                  mean(n>=3)
                  )




final_wide %>%
        group_by(cohort) %>%
        summarise(sum(!is.na(RAU_IgG_O139BSA)),
                  sum(is.na(RAU_IgA_O139BSA)|is.na(RAU_IgM_O139BSA)),
                  sum(is.na(RAU_IgA_O139BSA)|is.na(RAU_IgM_O139BSA))/236

                      )








        
```


## Supplement


### Table S1. Timing of sample collection for each cohort


```{r eval=FALSE}

ts1 <- final_wide %>%
        group_by(cohort,status) %>%
        mutate(Individuals=length(unique(id)))%>% 
        count(cohort,status,Individuals,day) %>%
        mutate(n_percent=glue::glue("{n} ({round(n/Individuals*100)})")) %>%
        arrange(cohort,status)%>% 
        mutate(
                exposure= case_when(
                        cohort %in% c("BGD Vaccinee","HTI Vaccinee") ~"Vaccination with Shanchol",
                        cohort == "ETEC Challenge" ~ "Challenged with Enterotoxigenic E. coli",
                        status=="Case" ~ "Natural infection with V. cholerae O1",
                        status=="Contact" ~ "Household member of case-patient infected with V. cholerae O1"
                ),
                Population=case_when(
                        cohort =="BGD Vaccinee" ~ "Bangladeshi volunteer",
                        cohort =="SMIC/PIC" & status=="Case" ~ "Bangladeshi case-patient",
                        cohort =="SMIC/PIC" & status=="Contact" ~ "Bangladeshi volunteer",
                        cohort =="HTI Vaccinee" ~ "Haitian volunteer",
                        cohort == "ETEC Challenge" ~ "North American volunteer"
                )
                
        ) %>%
        ungroup()%>%
        select(
                `Exposure Type`= exposure,
                Population,
                `Days since exposure`=day,
                Individuals,
                `Samples (%)`=n_percent
        ) %>%
        flextable::flextable() %>%
        flextable::autofit() 


ts1


ts1 %>% flextable::save_as_docx( path = "figures/tables/supp_table_1.docx")





```

### Figure S1. Baseline comparison of IgG markers


```{r}

#keep
# raw_baseline_plot <- final_df %>%
#         filter((status=="Vaccinee" & day==0)|status=="Case" & day==2) %>%
#         filter(antigen_pretty %in% c("CT-B","Ogawa OSP","Inaba OSP","O139 OSP","TcpA")) %>%
#         mutate(`Age Group`=ifelse(age>=10,"Adults","Children")) %>%
#         mutate(`Age Group`=factor(`Age Group`,levels=c("Children","Adults"))) %>%
#         mutate(isotype=factor(isotype,levels=c("IgG","IgA","IgM")))%>%
#         mutate(pretty_cohort=ifelse(cohort=="SMIC/PIC",
#                                     "BGD Case",cohort
#                                     ))%>%
#         ggplot(aes(y=RAU_value,col=pretty_cohort,group=pretty_cohort,x=`Age Group`))+
#                 geom_boxplot()+
#                 scale_y_continuous("Baseline log10(1/RAU)",breaks = c(0.25,1,4)) +
#                 scale_color_brewer("Cohort",palette = "Set1")+
#                 facet_grid(isotype~antigen_pretty)+
#                 theme_bw()+
#                 theme(legend.position="bottom"
#                       )


fs1 <- final_df %>%
        filter((status=="Vaccinee" & day==0)|status=="Case" & day==2) %>%
        filter(antigen_pretty %in% c("CT-B","Ogawa OSP","Inaba OSP","O139 OSP","TcpA")) %>%
        mutate(`Age Group`=ifelse(age<10,"<10 years old",">= 10 years old")) %>%
 
        mutate(isotype=factor(isotype,levels=c("IgG","IgA","IgM")))%>%
        mutate(pretty_cohort=ifelse(cohort=="SMIC/PIC",
                                    "Bangladeshi Case",
                                    str_replace(cohort,"BGD","Bangladeshi")
                                    ))%>%
        mutate(pretty_cohort=str_replace(pretty_cohort,"HTI","Haitian"))%>%
        filter(isotype=="IgG")%>%
        ggplot(aes(y=RAU_value,col=pretty_cohort,group=pretty_cohort,x=pretty_cohort))+
                # geom_boxplot()+
                ggbeeswarm::geom_beeswarm(alpha=0.8,
                                          cex=3
                                          )+
                scale_y_continuous("Baseline IgG log10(1/RAU)"#,breaks = c(0.25,1,4)
                                   
                                   ) +
                xlab("Cohort")+
                scale_color_brewer("Cohort",palette = "Set1")+
                facet_grid(`Age Group`~antigen_pretty)+
                theme_bw()+
                theme(legend.position="none",
                      axis.text.x = element_text(angle=45,hjust=1)
                      )


fs1


ggsave(plot=fs1,filename="figures/supplement/supp_figure1.png", height = 3.86,width = 6.5,scale = 1.2)

# bootDF <- read_rds("data/generated_data/analysis_objects/describe/bootDF.rds")




# GMT_ratio_plot <- bootDF %>%
#         group_by(isotype,antigen_pretty,`Age Group`) %>%
#         summarize(mean=mean(RAU_ratio),
#                   lb=quantile(RAU_ratio,0.025),
#                   ub=quantile(RAU_ratio,0.975)) %>%
#         # mutate(`Age Group`=factor(`Age Group`,levels=c("<10 years old",">= 10 years old"))) %>%
#         ggplot(aes(x=`Age Group`, col=isotype,y=mean))+
#                 geom_point(position = position_dodge(0.5))+
#                 geom_linerange(aes(ymin=lb,ymax=ub),
#                                position = position_dodge(0.5))+
#         facet_wrap(.~antigen_pretty,nrow=1)+
#         geom_hline(yintercept=1,lty=2)+
#         theme_bw()+
#         scale_y_continuous("Geometric Mean\nRAU Ratio", trans="log2")+
#         xlab("Age Group")+
#         theme(
#               legend.position = "bottom",
#                       panel.grid.minor = element_blank(),
#                      panel.grid.major.x =  element_blank(),
# 
#               )+
#         scale_color_brewer("Isotype",palette = "Dark2")
# 
# 
# plot_grid(raw_baseline_plot,
#           GMT_ratio_plot,
#           rel_heights = c(2,1),
#           ncol=1,
#           align = "v",
#           axis="lr",
#           labels=c("A","B")
#           )
```


### Table S2. Geometric mean fold-rise in RAU by marker among cases and vaccines 

```{r}
baseline_sero_data <- final_df %>%
        filter((status=="Vaccinee" & day %in% c(0,3))|(status=="Case" & day==2)) %>%
        group_by(id) %>%
        filter(day ==min(day)) %>%
        # filter(!id %in% c("IMS_A018","IMS_B021")) %>%
        select(id,status,cohort,antigen_pretty,isotype,baseline=RAU_value)
                       

peak_sero_data <- final_df %>% 
        filter(status %in% c("Vaccinee","Case")) %>%
        filter(!((status=="Vaccinee" & day %in% c(0,3))|(status=="Case" & day==2))) %>%
        group_by(id,antigen_pretty,isotype) %>%
        slice_max(order_by=RAU_value,n=1,with_ties = FALSE) %>%
        ungroup()%>%
        # filter(!id %in% c("IMS_A018","IMS_B021"))%>%
        select(id,status,cohort,antigen_pretty,isotype,peak=RAU_value,day)


sero180_data <- final_df %>% 
        filter(status %in% c("Vaccinee","Case")) %>%
        filter(day %in% 180) %>%
        # filter(!id %in% c("IMS_A018","IMS_B021"))%>%
        select(id,status,cohort,antigen_pretty,isotype,day180=RAU_value,day)


# final_df %>% 
#         filter(status %in% c("Vaccinee","Case")) %>%
#         filter(day %in% c(42,44,30)) %>%
#         count(cohort,day) 

# peak_sero_data %>%
#         filter(antigen_pretty=="Ogawa OSP") %>%
#         group_by(cohort,isotype) %>%
#         mutate(lb=quantile(day,0.25),
#                   ub=quantile(day,0.75)
#                   ) %>%
#         group_by(cohort,isotype,lb,ub) %>%
#         summarise(n=n(),
#                   peaked=sum(day>=lb&day<=ub)
#                   )%>%
#         mutate(peaked/n) %>%
#         arrange(isotype)


ts2_pv <- baseline_sero_data %>%
        filter(antigen_pretty %in% c("CT-B","Ogawa OSP","Inaba OSP",
                                     "O139 OSP", "TcpA"
                                     ))%>%
        left_join(peak_sero_data) %>%
        mutate(diff=peak-baseline) %>% 
        filter(!is.na(diff))%>%
        group_by(antigen_pretty,isotype) %>%
        summarise(`p-value`=t.test(diff[status=="Case"],diff[status=="Vaccinee"])$p.value) %>%
        mutate(`p-value`=ifelse(`p-value`<0.01,"<0.01",as.character(round(`p-value`,2))))

ts2 <- baseline_sero_data %>%
        filter(antigen_pretty %in% c("CT-B","Ogawa OSP","Inaba OSP",
                                     "O139 OSP", "TcpA"
                                     ))%>%
        left_join(peak_sero_data) %>%
        mutate(diff=peak-baseline) %>% 
        filter(!is.na(diff))%>%
        group_by(antigen_pretty,isotype,status) %>%
        summarize(gmt=round(10^mean(diff),1)) %>% 
        ungroup() %>% 
        left_join(ts2_pv)%>%
        spread(status,gmt)%>%
        rename(Antigen=antigen_pretty,
               Isotype=isotype
               )%>%
        arrange(Antigen,Isotype)%>%
        select(Antigen,Isotype,Case,Vaccinee,`p-value`)%>%
        flextable::flextable() %>%
        flextable::autofit()


ts2 


ts2 %>% flextable::save_as_docx( path = "figures/tables/supp_table_2.docx")


```

### Table S3. Proportion of individuals with a two fold-rise in RAU by marker among cases and vaccines 


```{r}

ts3_pv <- baseline_sero_data %>%
        filter(antigen_pretty %in% c("CT-B","Ogawa OSP","Inaba OSP",
                                     "O139 OSP", "TcpA"
                                     ))%>%
        left_join(peak_sero_data) %>%
        mutate(diff=peak-baseline) %>% 
        filter(!is.na(diff))%>%
        group_by(antigen_pretty,isotype) %>%
        mutate(over2=10^(diff)>=2) %>%
        summarize(`p-value`=fisher.test(over2,status)$p.value)%>%
        mutate(`p-value`=ifelse(`p-value`<0.01,"<0.01",as.character(round(`p-value`,2))))


ts3 <- baseline_sero_data %>%
        filter(antigen_pretty %in% c("CT-B","Ogawa OSP","Inaba OSP",
                                     "O139 OSP", "TcpA"
                                     ))%>%
        left_join(peak_sero_data) %>%
        mutate(diff=peak-baseline) %>% 
        filter(!is.na(diff))%>%
        group_by(antigen_pretty,isotype,status) %>%
        summarize(pct=paste0(100*round(mean(10^(diff)>=2),2),"%")) %>% 
        ungroup() %>% 
        left_join(ts3_pv)%>%
        spread(status,pct)%>%
        rename(Antigen=antigen_pretty,
               Isotype=isotype
               )%>%
        arrange(Antigen,Isotype)%>%
        select(Antigen,Isotype,Case,Vaccinee,`p-value`)%>%
        flextable::flextable() %>%
        flextable::autofit()

ts3

ts3%>% flextable::save_as_docx( path = "figures/tables/supp_table_3.docx")

```


## Table S4. Geometric mean ratio of measurements taken at the 180 day visit relative to baseline measurements for Bangladeshi cases and Haitian vaccinees

P-value in parentheses corresponds to the t-test of of the logarithm (base 10) of the ratio relative to the null value (i.e. zero).


```{r}


baseline_sero_data %>%
        filter(antigen_pretty %in% c("CT-B","Ogawa OSP","Inaba OSP",
                                     "O139 OSP", "TcpA"
                                     ))%>%
        left_join(sero180_data)%>%
        mutate(diff=day180-baseline) %>%
        filter(!is.na(diff)) %>%
        group_by(antigen_pretty,isotype,status) %>%
        summarize(gmt=round(10^mean(diff),1),
                  `p-value`=round(t.test(diff)$p.value,2)
                  ) %>%
        mutate(`p-value`=ifelse(`p-value`<0.01,"<0.01",as.character(round(`p-value`,2))))%>%
        mutate(new=paste0(gmt," (",`p-value`,")")) %>%
        select(antigen_pretty,isotype,status,new)%>%
        spread(status,new)%>%
        rename(Antigen=antigen_pretty,
               Isotype=isotype
               )%>%
        arrange(Antigen,Isotype)%>%
        select(Antigen,Isotype,Case,Vaccinee) %>% 
        View()






```



### Figure S2: Multidimensional scaling analysis of all serological data collected

```{r mds-code, eval=FALSE}

# multidimensional-scaling provides object with mds analysis
source("code/R/multidimensional-scaling.R")

```

```{r}
#get mds measurements
mds_obj <- read_rds("data/generated_data/analysis_objects/mds/mds_obj.rds")
permuted_distances <- read_rds("data/generated_data/analysis_objects/mds/permuted_distances.rds")

mds_obj %>%
        group_by(time_window,status) %>%
        summarise(avg_D1=mean(D1),
                  avg_D2=mean(D2)
                  ) %>%
        gather(dimension,value,-c(time_window,status)) %>%
        spread(status,value) %>%
        mutate(distance=(Case-Vaccinee)^2) %>%
        group_by(time_window) %>%
        summarise(euclidean=sqrt(sum(distance)))

permuted_distances %>%
        group_by(time_window) %>%
        summarize(quantile(euclidean,0.999))
centroids <- mds_obj %>%
                        group_by(time_window,status) %>%
                        summarize(D1=mean(D1),
                                  D2=mean(D2)
                                  )

fs2 <- mds_obj  %>%
        mutate(cohort=case_when(
                        cohort=="BGD Vaccinee" ~ "Bangladeshi Vaccinees",
                        cohort=="HTI Vaccinee" ~ "Haitian Vaccinees",
                        cohort=="SMIC/PIC" ~ "Bangladeshi Cases",

        ))%>%
                ggplot(aes(x=D1,y=D2,col=cohort)) +
                geom_point(aes(shape=cohort))+
                geom_point(data=centroids,col="black",shape=c(17,16,17,16,17,16))+
                scale_color_manual("Cohort", values=c("red","#003262","#FDB515"))+
                scale_shape_manual("Cohort",values=c(2,1,1))+
                xlab("Dimension 1")+
                ylab("Dimension 2")+
        facet_wrap(.~time_window,scales="free")+
        theme_cowplot()+
        theme(legend.position = "bottom")


ggsave(plot=fs2,filename="figures/supplement/supp_figure2.png", height = 2.4,width = 6.5,scale = 1.5)


```



### Figure S3: Misclassification of vaccinees as seropositive by previous seroincidence models with additional markers using 45, 120, 200, and 300 day infection windows. 



```{r}


misclassify_df <- read_rds("data/generated_data/analysis_objects/misclassification/misclassify_df.rds")
tvfpr_df <- read_rds("data/generated_data/analysis_objects/misclassification/tvfpr_df.rds")


misclassify_df%>% filter(variables=="All Variables")%>%
        filter(cohort %in% c("HTI Vaccinee","BGD Vaccinee"))%>%
        filter(end_window %in% c("45"))%>%
        group_by(day,end_window,cohort) %>%
        summarize(seropos=sum(spec95_seropos),
                  n=n(),
                  )%>%
        mutate(per_pos=seropos/n) %>% 
        arrange(cohort)


filter(tvfpr_df,population== "All Vaccinees (All Variables)") %>%
        filter(end_window %in% c(120,200,300)) %>%
        group_by(end_window) %>%
        filter(median==max(median))



filter(tvfpr_df,population== "All Vaccinees (All Variables)") %>%
        filter(end_window %in% c(120,200,300)) %>%
        group_by(end_window) %>%
        filter(median>=0.05) %>%
        filter(time==min(time))

filter(tvfpr_df,population== "All Vaccinees (All Variables)") %>%
        filter(end_window %in% c(120,200,300)) %>%
        group_by(end_window) %>%
        filter(median>=0.05) %>%
        filter(time==max(time))


# filter(tvfpr_df,population== "All Vaccinees (All Variables [NO AGE])") %>%
#         filter(end_window %in% c(120,200,300)) %>%
#         filter(time>14)%>%
#         group_by(end_window) %>%
#         slice_min(abs(median-0.05),n=1)


misclassify_df%>% filter(variables=="All Variables")%>%
        filter(cohort %in% c("ETEC Challenge"))%>%
        filter(end_window %in% c("200"))%>%
        group_by(day,end_window,cohort) %>%
        summarize(seropos=sum(spec95_seropos),
                  n=n(),
                  )%>%
        mutate(per_pos=seropos/n) 



fs3<- misclassify_df %>% filter(variables=="All Variables")%>%
        filter(cohort %in% c("HTI Vaccinee","BGD Vaccinee"))%>%
        group_by(day,end_window,cohort) %>%
        summarize(seropos=mean(spec95_seropos))%>%
        filter(end_window %in% c("45","120","200","300"))%>%
        mutate(end_window=factor(end_window,
                        levels=c("45","120","200","300"),
                        labels=c("45-day","120-day","200-day","300-day")))%>%
        mutate(Vaccinee=case_when(
                        cohort=="BGD Vaccinee" ~ "Bangladeshi",
                        cohort=="HTI Vaccinee" ~ "Haitian"
        )) %>%
        ggplot()+
        geom_point(aes(col=Vaccinee,
                   y=seropos,x=day,shape=Vaccinee))+
        geom_line(data=filter(tvfpr_df,population== "All Vaccinees (All Variables)")%>%
                        mutate(end_window=factor(end_window,
                                 levels=c("45","120","200","300"),
                                 labels=c("45-day","120-day","200-day","300-day"))),
                        aes(x=time,y=median))+
        geom_ribbon(data=filter(tvfpr_df,population== "All Vaccinees (All Variables)")%>%
                        mutate(end_window=factor(end_window,
                                 levels=c("45","120","200","300"),
                                 labels=c("45-day","120-day","200-day","300-day"))),
                        aes(x=time,ymin=lb,ymax=ub),col=NA,
                                    alpha=0.2,
                        )+
        facet_grid(.~end_window)+
        theme_cowplot()+
        scale_x_continuous("Days since first dose",breaks=seq(0,365,90))+
        scale_y_continuous("Proportion Seroincident")+
        scale_color_manual(values = c("#003262","#FDB515"))+
        scale_shape_manual(values=c(1,1))+
        geom_hline(yintercept = 0.05,lty=2)+
        theme(legend.position = "bottom")
        
        
nmfp_label_df <- data.frame(
                end_window="45",
                X=270,
                Y=0.15
) %>% mutate(end_window=factor(end_window,
                                 levels=c("45","120","200","300"),
                                 labels=c("45-day","120-day","200-day","300-day")))
  
fs3<- fs3 + geom_text(data=nmfp_label_df,
                label="Nominal false\npositivity rate",
                aes(x=X,y=Y),fontface="bold"
                )+
  geom_segment(data=nmfp_label_df,
               aes(xend = X, x = X,
               yend =Y-0.095,y=Y-0.05),
    arrow = arrow(length = unit(0.2,"cm"),
                  type="closed"
                  ))


fs3

ggsave(plot=fs3,filename="figures/supplement/supp_figure3.png", height = 2.5,width = 6.5,scale = 1.5)


```


### Figure S4: Comparison of performance of random forest models when serological data from vaccinees are included in the training set and additional markers. 


```{r }

#load the original model objects
tvfpr_df <- read_rds("data/generated_data/analysis_objects/misclassification/tvfpr_df.rds")
tvfpr_fit <- read_rds(
          paste0("data/generated_data/analysis_objects/misclassification/","tvfpr_fit.rds")
)

tvfpr_fit_200 <- tvfpr_fit$`200`$`All Vaccinees (All Variables)`

#load the new model objects

loocv_tvfit_df <- read_rds(
          paste0("data/generated_data/analysis_objects/loocv/","loocv_tvfit_df_new.rds")
)

loocv_tvfit_list <- read_rds(
          paste0("data/generated_data/analysis_objects/loocv/","loocv_tvfit_list_new.rds")
)

loocv_spec_df<- read_rds(
          paste0("data/generated_data/analysis_objects/loocv/","loocv_spec_df_new.rds")
)

loocv_df <- read_rds("data/generated_data/analysis_objects/loocv/loocv_df_new.rds")


p1 <- loocv_tvfit_df %>%
        filter(time<=200)%>%
        filter(population=="Vaccinee")%>%
        filter(str_detect(variables,"all"))%>%
        ggplot(aes(col=variables,fill=variables))+
                geom_line(aes(x=time,y=median))+
                geom_ribbon(aes(x=time,ymin=lb,ymax=ub),alpha=0.5,col=NA)+
                geom_line(data=tvfpr_df %>%
                                  filter(end_window==200)%>%
                                  filter(time<=200)%>%
                                  filter(population=="All Vaccinees (All Variables)"),
                          col="black",aes(x=time,y=median),lwd=1,
                          inherit.aes = FALSE
                          )+
        scale_color_manual(values = c("red","blue"))+
        scale_fill_manual(values = c("red","blue"))+
        xlab("Days since vaccination")+
        scale_y_continuous("False Positive Rate",limits = c(0,0.25))+
        geom_hline(yintercept = 0.05,lty=2,col="grey")+
        theme_cowplot()+
        theme(legend.position = "none")


p2_vax_df <- bind_rows(
        
        tvfpr_fit_200$out_df %>%
        filter(time<=200) %>% group_by(.draw)%>%
        summarize(avg=mean(theta)) %>%
        ungroup()%>%
        summarize(median=median(avg),
                  lb=quantile(avg,0.025),
                  ub=quantile(avg,0.975)
                  )%>%
        mutate(variables="original"),


        loocv_tvfit_list$all_2class$all_fitdata$`200-day`$Vaccinee$out_df %>%
        filter(time<=200) %>% group_by(.draw)%>%
        summarize(avg=mean(theta)) %>%
        ungroup()%>%
        summarize(median=median(avg),
                  lb=quantile(avg,0.025),
                  ub=quantile(avg,0.975)
                  )%>%
        mutate(variables="all_2class"),


        loocv_tvfit_list$all_3class$all_fitdata$`200-day`$Vaccinee$out_df %>%
        filter(time<=200)%>% group_by(.draw)%>%
        summarize(avg=mean(theta)) %>%
        ungroup()%>%
        summarize(median=median(avg),
                  lb=quantile(avg,0.025),
                  ub=quantile(avg,0.975)
                  ) %>%
                mutate(variables="all_3class")
) %>% mutate(population="Vaccinated")  

p2_outside_df <- loocv_spec_df %>% 
                        filter(str_detect(variables,"all")) %>%
                        filter(population=="Outside Window") %>%
                        mutate(variables=ifelse(base_data_name=="case_fitdata",
                                                "original",variables
                                                )) %>%
                        mutate(median=1-median,
                               lb_new=1-ub,
                               ub=1-lb
                               )%>%
                        select(median,lb=lb_new,ub,variables,population)%>%
                        mutate(population="Unvaccinated")

p2<- bind_rows(p2_outside_df,p2_vax_df)%>%
        mutate(Model=factor(variables,
                            levels=c("original","all_2class","all_3class"),
                             labels=c("Infection-Only model",
                                     "Mixed-Cohort\nTwo Class model",
                                     "Mixed-Cohort\nThree Class model"
                                     )
                            )) %>%
        mutate(population=factor(population))%>%
        mutate(population=fct_rev(population))%>%
        ggplot()+
                geom_point(aes(x=population,y=median,col=Model),
                           position = position_dodge(0.5)
                           )+
                geom_linerange(aes(x=population,ymin=lb,ymax=ub,col=Model),
                           position = position_dodge(0.5)
                           )+
        theme_cowplot()+
        geom_hline(yintercept = 0.05,lty=2,col="grey")+
        scale_color_manual(values = c("black","red","blue"))+
        scale_y_continuous("False Positive Rate",limits = c(0,0.25))+
        xlab("Population")

p3_df <- loocv_tvfit_df %>%
        filter(population=="Case")%>%
        filter(str_detect(variables,"all"))%>%
                        mutate(variables=ifelse(base_data_name=="case_fitdata",
                                                "original",variables
                                                )) %>%
        filter(time<=200)




p3 <- p3_df%>%
        filter(str_detect(variables,"all"))%>%
        ggplot(aes(col=variables,fill=variables))+
                geom_line(aes(x=time,y=median))+
                geom_ribbon(aes(x=time,ymin=lb,ymax=ub),alpha=0.5,col=NA)+
        geom_line(data=p3_df %>%
                          filter(variables=="original"),
                  col="black",aes(x=time,y=median), lwd=1,
                  inherit.aes = FALSE
                  )+
        scale_color_manual(values = c("red","blue"))+
        scale_fill_manual(values = c("red","blue"))+
        xlab("Days since infection")+
        scale_y_continuous("Sensitivity",limits=c(0,1))+
        theme_cowplot()+
        theme(legend.position = "none")

p4 <- loocv_df %>%
        filter(variables=="all_3class") %>%
        mutate(across(Neither:RecentlyVaccinated,.fns = ~ifelse(is.na(.x),
                                                                0,.x
                                                                ))) %>%
        mutate(prediction=case_when(
                Neither >= RecentlyInfected & Neither >=RecentlyVaccinated ~"Neither",
                RecentlyInfected > Neither & RecentlyInfected >= RecentlyVaccinated ~"RecentlyInfected",
                RecentlyVaccinated > Neither & RecentlyVaccinated > RecentlyInfected ~"RecentlyVaccinated"
        )) %>%
        mutate(three_class=factor(three_class),
                  prediction=factor(prediction)
        ) %>%
        count(variables,three_class,prediction,.drop=FALSE) %>%
        group_by(variables,three_class) %>%
        mutate(proportion=n/sum(n)) %>%
        mutate(three_class=str_replace(three_class,"Recently","Recently\n"))%>%
        mutate(three_class=glue::glue("{three_class}\n(n={sum(n)})"))%>%
        mutate(prediction=str_replace(prediction,"Recently","Recently "))%>%
        ggplot(aes(x=three_class,y=prediction))+
        geom_tile(aes(fill=100*proportion))+
        geom_text(aes(label=paste0(100*round(proportion,2),"%")))+
        scale_fill_distiller("Percent\nClassified",palette = "Blues",
                             direction = 1,limits=c(0,100),
        )+
        xlab("True Class")+
        ylab("Predicted Class")+
        theme_cowplot()


fs4 <- plot_grid(
        plot_grid(p1,p2,nrow=1,rel_widths = c(1,1), labels=c("A","B")),
        plot_grid(p3,p4,nrow = 1,rel_widths = c(1,1), labels=c("C","D")),
        nrow=2
        )


fs4

ggsave(plot=fs4,filename="figures/supplement/supp_figure4.png", height = 3,width = 6.09,scale =1.8)



```




### new figure

```{r}

library(glue)

loocv_df <- read_rds("data_original/generated_data/analysis_objects/loocv/loocv_df_new.rds")


loocv_df %>%
        filter(status=="Vaccinee") %>%
        count(variables,base_data_name,truth,spec95_seropos,pretty_status=status)

misclassify_df <- read_rds("data_original/generated_data/analysis_objects/misclassification/misclassify_df.rds")

confusion_mat_df <-   bind_rows(
                misclassify_df %>%
                        filter(end_window==200)%>%
        filter(status=="Vaccinee") %>%
                mutate(
                       base_data_name="case_fitdata"
                       )%>%
        count(variables,spec95_seropos,pretty_status=status,base_data_name),
        loocv_df %>%
        #only showing two class model here
        filter(str_detect(variables,"2"))%>%
        mutate(pretty_status=case_when(
                status== "Vaccinee" ~ "Vaccinee",
                truth==1 & status!= "Vaccinee" ~ "Case",
                truth==0 & status!= "Vaccinee" ~ "Outside Window"
        ))%>% 
        count(variables,base_data_name,spec95_seropos,pretty_status)
                
        )%>%
        group_by(variables,base_data_name,pretty_status) %>%
        mutate(total=sum(n)) %>%
        ungroup()%>%
        mutate(pretty_status=case_when(
                pretty_status== "Vaccinee" ~ glue("Vaccinee\n(n={total})"),
                pretty_status=="Case" ~ glue("Case\n(n={total})"),
                pretty_status=="Outside Window" ~glue("Outside\nWindow\n(n={total})")
        )) %>%
        mutate(percent=round(100*n/total)) %>%
        mutate(pretty_variables=ifelse(
                str_detect(variables,"reduced|Reduced"),
                "Three IgG Markers",
                "All Markers"
        )) %>%
        mutate(pretty_data=ifelse(str_detect(base_data_name,"case_"),
                                  "Case data only", 
                                  "Case and Vaccinee data"
                                  ))
        
confusion_mat_df %>%
        ggplot(aes(x=pretty_status,y=factor(spec95_seropos)))+
        geom_tile(aes(fill=percent),col="black")+
        geom_text(aes(label=glue("{n} ({percent}%)")))+
        scale_fill_distiller(aes(fill=percent),direction=1)+
        facet_grid(fct_rev(pretty_data)~fct_rev(pretty_variables))+
        theme_cowplot()+
        xlab("True status")+
        ylab("Predicted Status")+
        theme(legend.position = "none")


library(pROC)

bind_rows(
                misclassify_df %>%
                        filter(end_window==200)%>%
        filter(status=="Vaccinee") %>%
                mutate(
                       base_data_name="case_fitdata"
                       )%>%
        select(variables,prediction,pretty_status=status,base_data_name)%>%
        mutate(truth=0),
        loocv_df %>%
        #only showing two class model here
        filter(str_detect(variables,"2"))%>%
        mutate(pretty_status=case_when(
                status== "Vaccinee" ~ "Vaccinee",
                truth==1 & status!= "Vaccinee" ~ "Case",
                truth==0 & status!= "Vaccinee" ~ "Outside Window"
        ))%>% 
        select(variables,base_data_name,prediction,pretty_status,truth) %>%
        mutate(truth=as.numeric(as.character(truth)))
        )%>%
        mutate(pretty_variables=ifelse(
                str_detect(variables,"reduced|Reduced"),
                "Three IgG Markers",
                "All Markers"
        )) %>%
        mutate(pretty_data=ifelse(str_detect(base_data_name,"case_"),
                                  "Case data only", 
                                  "Case and Vaccinee data"
                                  ))%>%
        group_by(pretty_variables,pretty_data) %>%
        summarise(auc=as.numeric(auc(roc(truth,prediction))),
                  lb=as.numeric(ci.auc(roc(truth,prediction)))[1],
                  ub=as.numeric(ci.auc(roc(truth,prediction)))[3],
                  ) %>%
        mutate(pretty_auc=glue::glue("{round(auc,2)} ({round(lb,2)}-{round(ub,2)})"))%>%
        arrange(desc(pretty_variables),
                desc(pretty_data)
                ) %>%
        select(Markers=pretty_variables,
               `Training Data`= pretty_data,
               `Cross-Validated AUC (95% CI)`=pretty_auc
               )%>%
        flextable::flextable() %>%
        flextable::autofit()
        

# confusion_mat_df %>%
#         mutate(pretty_status=factor(pretty_status,labels=c("Case",
#                                                            "Outside\nWindow",
#                                                            "Vaccinee"
#                                                            )))%>%
#         filter(str_detect(variables,"all"))%>%
#         ggplot(aes(x=pretty_status,y=factor(spec95_seropos)))+
#         geom_tile(fill=NA,col="black")+
#         geom_text(aes(label=n))+
#         facet_grid(fct_rev(base_data_name)~(variables))+
#         theme_cowplot()



```




